<!DOCTYPE html>
<html>


    <head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>漏洞战争-cve-2012-0158</title>
<meta name="description" content="A blog about programming and network security">

<link rel="profile" href="https://gmpg.org/xfn/11" />
<! -- link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bbbbootstrap.min.css"-- >
<link rel="stylesheet" href="/css/my_code.css">
<link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css">
<link rel="stylesheet" type="text/css" media="all" href="/css/style.css" />
<link rel="stylesheet" type="text/css" media="all" href="/css/jquery.mmenu.all.css" />
<link rel="stylesheet" href="/css/highlightjs.piperita.css">

<!-- Favicons generated at https://realfavicongenerator.net/ -->
<link rel="apple-touch-icon" sizes="57x57" href="/favicons/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="/favicons/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="/favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="/favicons/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="/favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="/favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="/favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="/favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon-180x180.png">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-chrome-192x192.png" sizes="192x192">
<link rel="icon" type="image/png" href="/favicons/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="manifest" href="/favicons/manifest.json">
<link rel="shortcut icon" href="/favicons/favicon.ico">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-TileImage" content="/favicons/mstile-144x144.png">
<meta name="msapplication-config" content="/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">





</head>


    <body>

    <nav id="my-menu">
  <div>
    <p>quanyechavshuo</p>

    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <!--https://fontawesome.io/icons/ -->
    <br>
    <center>
    <font color="red" align="center"><i class="fa fa-link" aria-hidden="true"></i><a href="../../../../../bookmarks.html"><font color="red"> link</font></a></font>
    <br>
    <br>
    <font color="red" align="center"><i class="fa fa-key" aria-hidden="true"></i><a href="../../../../../book.html" target="_top"><font color="red"> book</font></a></font>
    <br>
    <br>
    <font color="red" align="center"><i class="fa fa-music" aria-hidden="true"></i><a href="../../../../../jquery-jplayer/index.html" target="_top"><font color="red"> music</font></a></font>
    <br>
    <br>
    <font color="red" align="center"><i class="fa fa-caret-square-o-right" aria-hidden="true"></i><a href="../../../../../mv.html" target="_top"><font color="red"> movie</font></a></font>
    </center>
    <p class="links">
  <a href="https://www.twitter.com/quanyechavshuo" target="_new"><i class="fa fa-twitter"></i></a>
  <a href="https://github.com/3xp10it" target="_new"><i class="fa fa-github-alt"></i></a>
  <a href="/feed.xml" target="_new"><i class="fa fa-rss"></i></a>
</p>

  </div>
</nav>
<div class="menu-button" href="#menu"><i class="fa fa-bars"></i></div>



    <div class="page-content">
      <div class="wrap">
      

<div class="container-fluid single">
  <div class="row">

    <div itemscope itemtype="https://schema.org/Article" class="col-md-12 article">
      

      <h1 class="header" itemprop="name">漏洞战争-cve-2012-0158</h1>

      <div class="author">
        <small><i>
          
          on <span itemprop="datePublished" content="2014-08-28">August 14, 2016</span>
           under 二进制
        </i></small>
      </div>

      <div class="read-time">
        <small>
          2 minute read
        </small>
      </div>

      <div class="content-panel content">

        

        <span itemprop="articleBody"><h3 id="x00-about">0x00 about</h3>

<div class="highlighter-rouge"><pre class="highlight"><code>实验环境:
    windows xp sp3
    office word 2003 sp3
    offvis1.1
漏洞描述:
    MSCOMCTL.OCX中存在栈溢出漏洞
</code></pre>
</div>

<h3 id="x01-">0x01 相关技巧</h3>

<div class="highlighter-rouge"><pre class="highlight"><code>1&gt;poc.doc是rtf格式,里面的ole数据以文本形式存储,offvis无法识别,导致不能通过offvis分析doc的结构,可通过winhex将
0xD0CF11E0开始至结尾的所有看上去是十六进制形式表示的文本数据保存为真正的十六进制值,最后有三个右大括号不属于十六
进制形式,也即将下面图1中poc.doc转成图2中的test.doc
    操作步骤:
    1&gt;winhex打开poc.doc,选中text区中的D0CF11E0到最后的0000(左边为hex区,右边为text区)
    2&gt;单击右键选择edit|copy block|normally
    3&gt;新建一个空白文件,20k大小(15k应该也够了)
    4&gt;在新建文件的offset为0处右键选择edit|copyboard data|paste,在弹出的对话框中选择最后一种粘贴方式,并保存为
    test.doc
</code></pre>
</div>
<p>图1
<img src="https://raw.githubusercontent.com/3xp10it/pic/master/cve-2012-0158-1.png" /></p>

<p>图2
<img src="https://raw.githubusercontent.com/3xp10it/pic/master/cve-2012-0158-2.png" /></p>

<div class="highlighter-rouge"><pre class="highlight"><code>2&gt;offvis相关分析中,打开重新生成的test.doc,在分析模块中选择最后一个,如下图3所示,41414141对应的数据在offvis分析
中的对应字段如下图4中所示
</code></pre>
</div>

<p>图3
<img src="https://raw.githubusercontent.com/3xp10it/pic/master/cve-2012-0158-3.png" /></p>

<p>图4
<img src="https://raw.githubusercontent.com/3xp10it/pic/master/cve-2012-0158-4.png" /></p>

<h3 id="x02-">0x02 调试分析</h3>

<div class="highlighter-rouge"><pre class="highlight"><code>打开word,od附加,在word中打开poc.doc,弹出出错框,错误地址为41414141,用上面的方法通过offvis分析找到对应字段为
Data,或者直接双击打开poc.doc,也是直接弹出出错对话框,od没有在eip=0x41414141时捕获异常,但是immunity debugger能够
在eip=0x41414141处中断并退出,可达到和windbg一样的效果(在cve-2011-0104的分析中，windbg可捕获到eip为一个正常地址
时对应的汇编指令为正常的汇编指令，但是该指令中访问了异常内存数据,而这里的情况是eip=41414141,是一个不正常的地址,
这里面没有指令),与此同时,od附加exe时会被系统异常处理程序先捕获eip=0x41414141这个异常,对比od和immunity debugger,
发现od中的调试选项中的异常默认处理情况如下图5，immunity debugger如图6
</code></pre>
</div>
<p>图5
<img src="https://raw.githubusercontent.com/3xp10it/pic/master/cve-2012-0158-5.png" /></p>

<p>图6
<img src="https://raw.githubusercontent.com/3xp10it/pic/master/cve-2012-0158-6.png" /></p>

<div class="highlighter-rouge"><pre class="highlight"><code>尝试将od的选项设置成和immunity debugger一样,依然会弹出如下图7中的系统异常对话框,看来od在捕获异常的功能上不如
immunity debugger
</code></pre>
</div>

<p>图7
<img src="https://raw.githubusercontent.com/3xp10it/pic/master/cve-2012-0158-7.png" /></p>

<div class="highlighter-rouge"><pre class="highlight"><code>重新选择immunity debugger附加打开的word.exe,word.exe打开poc.doc,immunity debugger捕获到word.exe崩溃并得到崩溃时
的数据如下：(esp=121468,ebp=00000000,eip=41414141)

    ------------------寄存器窗口中--------------------
        EAX 00000000
        ECX 7C93003D ntdll.7C93003D
        EDX 00140608
        EBX 09FB0810
        ESP 00121468
        EBP 00000000
        ESI 002100B4
        EDI 00000000
        EIP 41414141
        C 0  ES 0023 32bit 0(FFFFFFFF)
        P 1  CS 001B 32bit 0(FFFFFFFF)
        A 0  SS 0023 32bit 0(FFFFFFFF)
        Z 1  DS 0023 32bit 0(FFFFFFFF)
        S 0  FS 003B 32bit 7FFDE000(FFF)
        T 0  GS 0000 NULL
        D 0
        O 0  LastErr ERROR_SUCCESS (00000000)
        EFL 00010246 (NO,NB,E,BE,NS,PE,GE,LE)
        ST0 empty
        ST1 empty
        ST2 empty
        ST3 empty
        ST4 empty
        ST5 empty
        ST6 empty
        ST7 empty
                       3 2 1 0      E S P U O Z D I
        FST 4000  Cond 1 0 0 0  Err 0 0 0 0 0 0 0 0  (EQ)
        FCW 127F  Prec NEAR,53  Mask    1 1 1 1 1 1
    ---------------------end--------------------------
    
    -------------------------堆栈窗口中-----------------------------
    001213EC   00000001  ...
    001213F0   0012F904  ?.
    001213F4   7C92E900  .閽|   ntdll.7C92E900
    001213F8   7C930040  @.搢   ntdll.7C930040
    001213FC   FFFFFFFF  
    00121400   7C93003D  =.搢   ntdll.7C93003D
    00121404   275C8800  .圽'   MSCOMCTL.275C8800
    00121408   00140000  ...
    0012140C   00000000  ....
    00121410   08D9B008  百
    00121414   00000000  ....
    00121418   002100B4  ?!.
    0012141C   09FB0810  ?
    00121420   00008282  倐..
    00121424   00121458  X.
    00121428   275C8A0A  .奬'   MSCOMCTL.275C8A0A
    0012142C   00121450  P.
    00121430   08D9B008  百
    00121434   00008282  倐..
    00121438   00000000  ....
    0012143C   002100B4  ?!.
    00121440   09FB0810  ?
    00121444   6A626F43  Cobj
    00121448   00000064  d...
    0012144C   00008282  倐..
    00121450   00000000  ....
    00121454   00000000  ....
    00121458   00000000  ....
    0012145C   41414141  AAAA
    00121460   00000000  ....
    00121464   00000000  ....
    00121468   00000000  ....  ------&gt;   &lt;崩溃时esp的值为121468&gt;
    0012146C   00000000  ....
    00121470   00000000  ....
    00121474   00000000  ....
    00121478   00000000  ....
    0012147C   00000000  ....
    00121480   00000000  ....
    00121484   00000000  ....
    00121488   00000000  ....
    0012148C   00000000  ....
    00121490   00000000  ....
    00121494   00000000  ....
    00121498   00000000  ....
    0012149C   00000000  ....
    001214A0   00000000  ....
    001214A4   00000000  ....
    001214A8   00000000  ....
    001214AC   00000000  ....
    001214B0   00000000  ....
    001214B4   00000000  ....
    001214B8   00000000  ....
    001214BC   00000000  ....
    001214C0   00000000  ....
    001214C4   00000000  ....
    001214C8   00000000  ....
    ----------------------------end---------------------------------
    
</code></pre>
</div>
</span>

        


        
        <div class="tags">
          <small>
          <i class="fa fa-tags"></i>
            漏洞分析, 漏洞战争, 栈溢出
          </small>
        </div>
        

      </div>

      
      <div class="content-panel feedback">
        I <i class="fa fa-heart"></i> feedback.<br />
        Let me know what you think of this article on twitter <a href="https://www.twitter.com/quanyechavshuo">@quanyechavshuo</a>!
      </div>
      


      



      
<!-- 多说评论框 start -->
<div class="ds-thread" data-thread-key="/%E4%BA%8C%E8%BF%9B%E5%88%B6/2016/08/14/漏洞战争-cve-2012-0158" data-title="" data-url="https://3xp10it.github.io//%E4%BA%8C%E8%BF%9B%E5%88%B6/2016/08/14/%E6%BC%8F%E6%B4%9E%E6%88%98%E4%BA%89-cve-2012-0158/"></div>
<!-- 多说评论框 end -->
<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"3xp10it"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
<!-- 多说公共JS代码 end -->
      


      

    </div>

  </div>

</div>





      </div>
    </div>

    <div class="footer clearfix">
  <div class="col-md-12">
    for better experience please install font 文泉驿等宽正黑
  </div>
</div>

<div class="my-home"><i class="fa fa-home" aria-hidden="true"></i><a href="/index2.html"> <font color="white">home</font></a></div>
<div class="my-papers"><i class="fa fa-github" aria-hidden="true"></i><a href="https://github.com/3xp10it" target="_top"> <font color="white">papers</font></a></div>
<div class="my-search"><i class="fa fa-search" aria-hidden="true"></i><a href="/search/"> <font color="white">search</font></a></div>
<div class="my-archive"><i class="fa fa-apple" aria-hidden="true"></i><a href="/my-archive/"> <font color="white">archive</font></a></div>
<div class="my-categories"><i class="fa fa-tags" aria-hidden="true"></i><a href="/my-categories/"> <font color="white">categories</font></a></div>


<script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
<script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
<script src="/js/jquery.mmenu.min.all.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.7/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script type="text/javascript">
   $(document).ready(function() {
      $("#my-menu").mmenu().on( "closed.mm", function() {
            $(".menu-button").show();
         });
      $(".menu-button").click(function() {
        $(".menu-button").hide();
        $("#my-menu").trigger("open.mm");
      });
   });
</script>






    </body>
</html>
