<!DOCTYPE html>
<html>


    <head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>漏洞战争-cve-2010-2553</title>
<meta name="description" content="A blog about programming and network security">

<link rel="profile" href="https://gmpg.org/xfn/11" />
<! -- link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bbbbootstrap.min.css"-- >
<link rel="stylesheet" href="/css/my_code.css">
<link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css">
<link rel="stylesheet" type="text/css" media="all" href="/css/style.css" />
<link rel="stylesheet" type="text/css" media="all" href="/css/jquery.mmenu.all.css" />
<link rel="stylesheet" href="/css/highlightjs.piperita.css">

<!-- Favicons generated at https://realfavicongenerator.net/ -->
<link rel="apple-touch-icon" sizes="57x57" href="/favicons/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="/favicons/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="/favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="/favicons/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="/favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="/favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="/favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="/favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon-180x180.png">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-chrome-192x192.png" sizes="192x192">
<link rel="icon" type="image/png" href="/favicons/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="manifest" href="/favicons/manifest.json">
<link rel="shortcut icon" href="/favicons/favicon.ico">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-TileImage" content="/favicons/mstile-144x144.png">
<meta name="msapplication-config" content="/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">





</head>


    <body>

    <nav id="my-menu">
  <div>
    <p>quanyechavshuo</p>

    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <!--https://fontawesome.io/icons/ -->
    <br>
    <center>
    <font color="red" align="center"><i class="fa fa-link" aria-hidden="true"></i><a href="../../../../../bookmarks.html"><font color="red"> link</font></a></font>
    <br>
    <br>
    <font color="red" align="center"><i class="fa fa-key" aria-hidden="true"></i><a href="../../../../../book.html" target="_top"><font color="red"> book</font></a></font>
    <br>
    <br>
    <font color="red" align="center"><i class="fa fa-music" aria-hidden="true"></i><a href="../../../../../jquery-jplayer/index.html" target="_top"><font color="red"> music</font></a></font>
    <br>
    <br>
    <font color="red" align="center"><i class="fa fa-caret-square-o-right" aria-hidden="true"></i><a href="../../../../../mv.html" target="_top"><font color="red"> movie</font></a></font>
    </center>
    <p class="links">
  <a href="https://www.twitter.com/quanyechavshuo" target="_new"><i class="fa fa-twitter"></i></a>
  <a href="https://github.com/3xp10it" target="_new"><i class="fa fa-github-alt"></i></a>
  <a href="/feed.xml" target="_new"><i class="fa fa-rss"></i></a>
</p>

  </div>
</nav>
<div class="menu-button" href="#menu"><i class="fa fa-bars"></i></div>



    <div class="page-content">
      <div class="wrap">
      

<div class="container-fluid single">
  <div class="row">

    <div itemscope itemtype="https://schema.org/Article" class="col-md-12 article">
      

      <h1 class="header" itemprop="name">漏洞战争-cve-2010-2553</h1>

      <div class="author">
        <small><i>
          
          on <span itemprop="datePublished" content="2014-08-28">August 17, 2016</span>
           under 二进制
        </i></small>
      </div>

      <div class="read-time">
        <small>
          3 minute read
        </small>
      </div>

      <div class="content-panel content">

        

        <span itemprop="articleBody"><h3 id="x00-">0x00 堆溢出基础知识</h3>

<div class="highlighter-rouge"><pre class="highlight"><code>1&gt;good link:
    http://blog.csdn.net/ithzhang/article/details/12711431
    http://www.mottoin.com/87277.html
    http://www.voidcn.com/blog/u010797814/article/p-3924286.html

2&gt;堆表只索引所有的空闲态堆块,已分配|占用的堆块由使用它的程序索引,空闲态堆块和占用态堆块:

    堆块使用_HEAP_ENTYR结构来描述,该结构占8Byte. _HEAP_ENTRY结构之后就是供应用程序使用的区域.调用HeapAlloc函数
    将返回HEAP_ENTRY之后的地址.此地址减去8Byte便可以得到_HEAP_ENTRY结构.对于已经释放的堆块,堆管理器定义了
    _HEAP_FREE_ENTRY结构来描述.该结构的前八个字节与_HEAP_ENTRY结构完全相同.但增加了8个字节来存储空闲链表的头节点.
    _HEAP_FREE_ENTRY是空闲态堆块中的块首(8byte)与flink,blink(4+4=8)的总和,_HEAP_FREE_ENTRY共16byte,_HEAP_ENTRY
    是占用态堆块中对应的块首的结构,大小为8byte.
    如下图:
</code></pre>
</div>
<p><img src="https://raw.githubusercontent.com/3xp10it/pic/master/heap-1.png" /></p>

<div class="highlighter-rouge"><pre class="highlight"><code>3&gt;堆溢出实质:
    [flink+4]=blink
    [blink]=flink

4&gt;调试堆与调试栈不同,不能直接用调试器来加载程序,否则堆管理函数会检测到当前进程处于调试状态,而使用调试态堆管理
  策略
</code></pre>
</div>

<h3 id="x01-">0x01 堆溢出原理</h3>

<h4 id="day2">1&gt;0day2实例</h4>

<div class="highlighter-rouge"><pre class="highlight"><code>-----------------0dayheap.c-(page:152)--------
#include &lt;windows.h&gt;
int main()
{
    HLOCAL h1,h2,h3,h4,h5,h6;
    HANDLE hp;
    getchar();//将书中下面的__asm int 3改成这里的getchar(),因为实际中将od设为实时调试提示有问题
    hp=HeapCreate(0,0x1000,0x10000);//创建一个0x1000=4096大小的堆
    //__asm int 3,书中是__asm int 3,在winxp sp3上测试中断效果还好,改成上面的getchar()

    h1=HeapAlloc(hp,HEAP_ZERO_MEMORY,3);
    h2=HeapAlloc(hp,HEAP_ZERO_MEMORY,5);
    h3=HeapAlloc(hp,HEAP_ZERO_MEMORY,6);
    h4=HeapAlloc(hp,HEAP_ZERO_MEMORY,8);
    h5=HeapAlloc(hp,HEAP_ZERO_MEMORY,19);
    h6=HeapAlloc(hp,HEAP_ZERO_MEMORY,24);

    //free block and prevent coaleses
    HeapFree(hp,0,h1);//free to freelist[2]
    HeapFree(hp,0,h3);//free to freelist[2]
    HeapFree(hp,0,h5);//free to freelist[4]

    HeapFree(hp,0,h4);//coalese h3,h4,h5,link the large block to freelist[8]

    return 0;
}
--------------------end-----------------------

编译成release版本exe
双击运行0dayheap.exe
od附加
f9
alt+e选择0dayheap.exe
在00401018的call HeapCreate处下断

    00401018    FF15 08604000   call dword ptr ds:[&lt;&amp;KERNEL32.HeapCreate&gt;; kernel32.HeapCreate
    0040101E    8B3D 04604000   mov edi,dword ptr ds:[&lt;&amp;KERNEL32.HeapAll&gt;; ntdll.RtlAllocateHeap
    
在0dayheap.exe的窗口中输入"a",enter
发现od没有成功中断,可能是od的原因
alt+v
t
resume all threads
中断在401018处
f8
    此时eax=3a0000,也即heapcreate创建的堆的起始地址为3a0000
在寄存器窗口中右键eax,在数据窗口中跟随

    003A0000  C8 00 00 00 7A 01 00 00 FF EE FF EE 00 10 00 00  ?..z..??..
    003A0010  00 00 00 00 00 FE 00 00 00 00 10 00 00 20 00 00  .....?..... ..
    003A0020  00 02 00 00 00 20 00 00 30 01 00 00 FF EF FD 7F  .... ..0..稞
    003A0030  05 00 08 06 00 00 00 00 00 00 00 00 00 00 00 00  .............
    003A0040  00 00 00 00 98 05 3A 00 0F 00 00 00 F8 FF FF FF  ....?:....?
    003A0050  50 00 3A 00 50 00 3A 00 40 06 3A 00 00 00 00 00  P.:.P.:.@:.....
    003A0060  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    003A0070  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................

alt+m也可以查看堆的起始地址,如下图
</code></pre>
</div>

<p><img src="https://raw.githubusercontent.com/3xp10it/pic/master/heap-2.png" /></p>

<div class="highlighter-rouge"><pre class="highlight"><code>在003a000那一行上右键复制一行,粘贴如下:
    Memory map, 条目 15
     地址=003A0000
     大小=00001000 (4096.)
     属主=         003A0000 (自身)
     区段=
     类型=Priv 00021004
     访问=RW
     初始访问=RW

在数据窗口中的003a0000的0x178偏移也即3a0178,是空表索引,也即3a0178指向freelist,3a0178处的值为freelist的第一项内容,如下:
    
    003A0170  00 00 00 00 00 00 00 00      88 06 3A 00 88 06 3A 00  ........?:.?:.

    free[0]=0x003a0178
    free[0].flink=[3a0178]=003a0688
    free[0].blink=[3a0178+4]=003a0688

003a0688处的数据窗口值如下:

    003A0688  78 01 3A 00 78 01 3A 00 00 00 00 00 00 00 00 00  x:.x:.........
    003A0698  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................

    free[-1]=0x003a0688
    free[-1].flink=[3a0688]=003a0178    ====free[0]
    free[-1].blink=[3a0688+4]=003a0178
    
    可以看出HeapCreate产生的堆中的空表只有两项,也即只有一个堆块,且堆块索引为free[-1]+8=0x003a0690
    h1=HeapAlloc(hp,HEAP_ZERO_MEMORY,3);//实际分配16字节,预测h1=0x3a0690
    h2=HeapAlloc(hp,HEAP_ZERO_MEMORY,5);//实际分配16字节,预测h2=0x3a0690+16=0x3a06a0
    h3=HeapAlloc(hp,HEAP_ZERO_MEMORY,6);//实际分配16字节,预测h3=0x3a0690+16*2=0x3a06b0
    h4=HeapAlloc(hp,HEAP_ZERO_MEMORY,8);//实际分配16字节,预测h4=0x3a0690+16*3=0x3a06c0
    h5=HeapAlloc(hp,HEAP_ZERO_MEMORY,19);//实际分配32字节,预测h5=0x3a0690+16*4=0x3a06d0
    h6=HeapAlloc(hp,HEAP_ZERO_MEMORY,24);//实际分配32字节,预测h6=0x3a0690+16*4+32=0x3a06f0

在六处HeapAlloc上下断

    00401018    FF15 08604000   call dword ptr ds:[&lt;&amp;KERNEL32.HeapCreate&gt;]          ; kernel32.HeapCreate
    0040101E    8B3D 04604000   mov edi,dword ptr ds:[&lt;&amp;KERNEL32.HeapAlloc&gt;]        ; ntdll.RtlAllocateHeap
    00401024    8BF0            mov esi,eax
    00401026    6A 03           push 0x3
    00401028    6A 08           push 0x8
    0040102A    56              push esi
    0040102B    FFD7            call edi     --------&gt;f2
    0040102D    6A 05           push 0x5
    0040102F    6A 08           push 0x8
    00401031    56              push esi
    00401032    8BD8            mov ebx,eax
    00401034    FFD7            call edi     --------&gt;f2
    00401036    6A 06           push 0x6
    00401038    6A 08           push 0x8
    0040103A    56              push esi
    0040103B    FFD7            call edi     --------&gt;f2
    0040103D    6A 08           push 0x8
    0040103F    6A 08           push 0x8
    00401041    56              push esi
    00401042    8BE8            mov ebp,eax
    00401044    FFD7            call edi     --------&gt;f2
    00401046    6A 13           push 0x13
    00401048    6A 08           push 0x8
    0040104A    56              push esi
    0040104B    894424 20       mov dword ptr ss:[esp+0x20],eax
    0040104F    FFD7            call edi     --------&gt;f2
    00401051    6A 18           push 0x18
    00401053    6A 08           push 0x8
    00401055    56              push esi
    00401056    894424 1C       mov dword ptr ss:[esp+0x1C],eax
    0040105A    FFD7            call edi     --------&gt;f2

f8
f8
..
(eip=0x40102d)
    到40102d处eax=0x3a0688,也即h1=0x3a0688,说明预测错了,因为分配上面唯一的堆块(free[-1]=003a0688)分配以后就不
    再是空闲堆块了，变成占用态的堆块，占用态的堆块是没有flink和blik的，也即占用态的堆块的索引不属于空表中,属于
    应用程序,属于应用程序.上面唯一的堆块分割以后的堆块是在0x3a0688处割下16个字节（h1的大小)后剩下的唯一的堆块,
    现在0x3a688处的数据如下：
        
    003A0688  00 00 00 00 78 01 3A 00 2E 01 02 00 00 10 00 00  ....x:......
    003A0698  78 01 3A 00 78 01 3A 00 00 00 00 00 00 00 00 00  x:.x:.........

    重新预测:
    h1=003a0688
        h1堆块的块首在h1-8=3a0680处：
        003A0680:
        02 00 08 00 AA 01 0D 00          ..?..
        块首的前2个字节对应当前堆块的大小,第3-4个字节对应前一个堆块大小,这里前2个字节为0008,也即当前堆块大小为8
        字节,第3-4字节为0002，即前一个堆块大小为2
    h2=003a0698
    h3=003a06a8
    h4=003a06b8
    h5=003a06c8
    h6=003a06e8

f8
f8
...
(eip=00401036)
    到00401036处eax=3a0698,也即h2=0x3a0698与预测结果一致,h2堆块的块首在h2-8=3a0690处:
    003a0690:
    02 00 02 00 A8 01 0B 00          ..?.








</code></pre>
</div>

<h4 id="section">2&gt;漏洞战争实例</h4>

<div class="highlighter-rouge"><pre class="highlight"><code>------------------heapoverflow.c---------------------
#include &lt;windows.h&gt;
#include &lt;stdio.h&gt;

int main()
{
    HANDLE hHeap;
    char *heap;
    char str[]="AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA";
    hHeap=HeapCreate(HEAP_GENERATE_EXCEPTIONS,0x1000,0xffff);
    getchar();

    heap=HeapAlloc(hHeap,0,0x10);
    printf("heap addr:0x%08x\n",heap);

    strcpy(heap,str);
    HeapFree(hHeap,0,heap);

    HeapDestroy(hHeap);
    return 0;
}
------------------------end--------------------------
</code></pre>
</div>
</span>

        


        
        <div class="tags">
          <small>
          <i class="fa fa-tags"></i>
            漏洞战争, 漏洞分析, 堆溢出
          </small>
        </div>
        

      </div>

      
      <div class="content-panel feedback">
        I <i class="fa fa-heart"></i> feedback.<br />
        Let me know what you think of this article on twitter <a href="https://www.twitter.com/quanyechavshuo">@quanyechavshuo</a>!
      </div>
      


      



      
<!-- 多说评论框 start -->
<div class="ds-thread" data-thread-key="/%E4%BA%8C%E8%BF%9B%E5%88%B6/2016/08/17/漏洞战争-cve-2010-2553" data-title="" data-url="https://3xp10it.github.io//%E4%BA%8C%E8%BF%9B%E5%88%B6/2016/08/17/%E6%BC%8F%E6%B4%9E%E6%88%98%E4%BA%89-cve-2010-2553/"></div>
<!-- 多说评论框 end -->
<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"3xp10it"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
<!-- 多说公共JS代码 end -->
      


      

    </div>

  </div>

</div>





      </div>
    </div>

    <div class="footer clearfix">
  <div class="col-md-12">
    for better experience please install font 文泉驿等宽正黑
  </div>
</div>

<div class="my-home"><i class="fa fa-home" aria-hidden="true"></i><a href="/index2.html"> <font color="white">home</font></a></div>
<div class="my-papers"><i class="fa fa-github" aria-hidden="true"></i><a href="https://github.com/3xp10it" target="_top"> <font color="white">papers</font></a></div>
<div class="my-search"><i class="fa fa-search" aria-hidden="true"></i><a href="/search/"> <font color="white">search</font></a></div>
<div class="my-archive"><i class="fa fa-apple" aria-hidden="true"></i><a href="/my-archive/"> <font color="white">archive</font></a></div>
<div class="my-categories"><i class="fa fa-tags" aria-hidden="true"></i><a href="/my-categories/"> <font color="white">categories</font></a></div>


<script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
<script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
<script src="/js/jquery.mmenu.min.all.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.7/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script type="text/javascript">
   $(document).ready(function() {
      $("#my-menu").mmenu().on( "closed.mm", function() {
            $(".menu-button").show();
         });
      $(".menu-button").click(function() {
        $(".menu-button").hide();
        $("#my-menu").trigger("open.mm");
      });
   });
</script>






    </body>
</html>
