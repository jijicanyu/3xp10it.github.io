<!DOCTYPE html>
<html>


    <head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ¼æ´æˆ˜äº‰-cve-2010-2553</title>
<meta name="description" content="A blog about programming and network security">

<link rel="profile" href="https://gmpg.org/xfn/11" />
<! -- link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bbbbootstrap.min.css"-- >
<link rel="stylesheet" href="/css/my_code.css">
<link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css">
<link rel="stylesheet" type="text/css" media="all" href="/css/style.css" />
<link rel="stylesheet" type="text/css" media="all" href="/css/jquery.mmenu.all.css" />
<link rel="stylesheet" href="/css/highlightjs.piperita.css">

<!-- Favicons generated at https://realfavicongenerator.net/ -->
<link rel="apple-touch-icon" sizes="57x57" href="/favicons/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="/favicons/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="/favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="/favicons/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="/favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="/favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="/favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="/favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon-180x180.png">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-chrome-192x192.png" sizes="192x192">
<link rel="icon" type="image/png" href="/favicons/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="manifest" href="/favicons/manifest.json">
<link rel="shortcut icon" href="/favicons/favicon.ico">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-TileImage" content="/favicons/mstile-144x144.png">
<meta name="msapplication-config" content="/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">





</head>


    <body>

    <nav id="my-menu">
  <div>
    <p>quanyechavshuo</p>

    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <!--https://fontawesome.io/icons/ -->
    <br>
    <center>
    <font color="red" align="center"><i class="fa fa-link" aria-hidden="true"></i><a href="../../../../../bookmarks.html"><font color="red"> link</font></a></font>
    <br>
    <br>
    <font color="red" align="center"><i class="fa fa-key" aria-hidden="true"></i><a href="../../../../../book.html" target="_top"><font color="red"> book</font></a></font>
    <br>
    <br>
    <font color="red" align="center"><i class="fa fa-music" aria-hidden="true"></i><a href="../../../../../jquery-jplayer/index.html" target="_top"><font color="red"> music</font></a></font>
    <br>
    <br>
    <font color="red" align="center"><i class="fa fa-caret-square-o-right" aria-hidden="true"></i><a href="../../../../../mv.html" target="_top"><font color="red"> movie</font></a></font>
    </center>
    <p class="links">
  <a href="https://www.twitter.com/quanyechavshuo" target="_new"><i class="fa fa-twitter"></i></a>
  <a href="https://github.com/3xp10it" target="_new"><i class="fa fa-github-alt"></i></a>
  <a href="/feed.xml" target="_new"><i class="fa fa-rss"></i></a>
</p>

  </div>
</nav>
<div class="menu-button" href="#menu"><i class="fa fa-bars"></i></div>



    <div class="page-content">
      <div class="wrap">
      

<div class="container-fluid single">
  <div class="row">

    <div itemscope itemtype="https://schema.org/Article" class="col-md-12 article">
      

      <h1 class="header" itemprop="name">æ¼æ´æˆ˜äº‰-cve-2010-2553</h1>

      <div class="author">
        <small><i>
          
          on <span itemprop="datePublished" content="2014-08-28">August 17, 2016</span>
           under äºŒè¿›åˆ¶
        </i></small>
      </div>

      <div class="read-time">
        <small>
          12 minute read
        </small>
      </div>

      <div class="content-panel content">

        

        <span itemprop="articleBody"><h3 id="x00-">0x00 å †æº¢å‡ºåŸºç¡€çŸ¥è¯†</h3>

<div class="highlighter-rouge"><pre class="highlight"><code>1&gt;good link:
    http://blog.csdn.net/ithzhang/article/details/12711431
    http://www.mottoin.com/87277.html
    http://www.voidcn.com/blog/u010797814/article/p-3924286.html

2&gt;å †è¡¨åªç´¢å¼•æ‰€æœ‰çš„ç©ºé—²æ€å †å—,å·²åˆ†é…|å ç”¨çš„å †å—ç”±ä½¿ç”¨å®ƒçš„ç¨‹åºç´¢å¼•,ç©ºé—²æ€å †å—å’Œå ç”¨æ€å †å—:

    å †å—ä½¿ç”¨_HEAP_ENTYRç»“æ„æ¥æè¿°,è¯¥ç»“æ„å 8Byte. _HEAP_ENTRYç»“æ„ä¹‹åå°±æ˜¯ä¾›åº”ç”¨ç¨‹åºä½¿ç”¨çš„åŒºåŸŸ.è°ƒç”¨HeapAllocå‡½æ•°
    å°†è¿”å›HEAP_ENTRYä¹‹åçš„åœ°å€.æ­¤åœ°å€å‡å»8Byteä¾¿å¯ä»¥å¾—åˆ°_HEAP_ENTRYç»“æ„.å¯¹äºå·²ç»é‡Šæ”¾çš„å †å—,å †ç®¡ç†å™¨å®šä¹‰äº†
    _HEAP_FREE_ENTRYç»“æ„æ¥æè¿°.è¯¥ç»“æ„çš„å‰å…«ä¸ªå­—èŠ‚ä¸_HEAP_ENTRYç»“æ„å®Œå…¨ç›¸åŒ.ä½†å¢åŠ äº†8ä¸ªå­—èŠ‚æ¥å­˜å‚¨ç©ºé—²é“¾è¡¨çš„å¤´èŠ‚ç‚¹.
    _HEAP_FREE_ENTRYæ˜¯ç©ºé—²æ€å †å—ä¸­çš„å—é¦–(8byte)ä¸flink,blink(4+4=8)çš„æ€»å’Œ,_HEAP_FREE_ENTRYå…±16byte,_HEAP_ENTRY
    æ˜¯å ç”¨æ€å †å—ä¸­å¯¹åº”çš„å—é¦–çš„ç»“æ„,å¤§å°ä¸º8byte.
    å¦‚ä¸‹å›¾:
</code></pre>
</div>
<p><img src="https://raw.githubusercontent.com/3xp10it/pic/master/heap-1.png" /></p>

<div class="highlighter-rouge"><pre class="highlight"><code>3&gt;å †æº¢å‡ºå®è´¨:
    [flink+4]=blink
    [blink]=flink

    å…¶ä¸­flinkä»£è¡¨ä¸‹ä¸€ä¸ªå †å—çš„ç´¢å¼•,blinkä»£è¡¨å‰ä¸€ä¸ªå †å—çš„ç´¢å¼•

4&gt;è°ƒè¯•å †ä¸è°ƒè¯•æ ˆä¸åŒ,ä¸èƒ½ç›´æ¥ç”¨è°ƒè¯•å™¨æ¥åŠ è½½ç¨‹åº,å¦åˆ™å †ç®¡ç†å‡½æ•°ä¼šæ£€æµ‹åˆ°å½“å‰è¿›ç¨‹å¤„äºè°ƒè¯•çŠ¶æ€,è€Œä½¿ç”¨è°ƒè¯•æ€å †ç®¡ç†
  ç­–ç•¥
</code></pre>
</div>

<h3 id="x01-">0x01 å †æº¢å‡ºåŸç†</h3>

<h4 id="day2">1&gt;0day2å®ä¾‹</h4>

<div class="highlighter-rouge"><pre class="highlight"><code>-----------------0dayheap.c-(page:152)--------
#include &lt;windows.h&gt;
int main()
{
    HLOCAL h1,h2,h3,h4,h5,h6;
    HANDLE hp;
    getchar();//å°†ä¹¦ä¸­ä¸‹é¢çš„__asm int 3æ”¹æˆè¿™é‡Œçš„getchar(),å› ä¸ºå®é™…ä¸­å°†odè®¾ä¸ºå®æ—¶è°ƒè¯•æç¤ºæœ‰é—®é¢˜
    hp=HeapCreate(0,0x1000,0x10000);//åˆ›å»ºä¸€ä¸ª0x1000=4096å¤§å°çš„å †
    //__asm int 3,ä¹¦ä¸­æ˜¯__asm int 3,åœ¨winxp sp3ä¸Šæµ‹è¯•ä¸­æ–­æ•ˆæœè¿˜å¥½,æ”¹æˆä¸Šé¢çš„getchar()

    h1=HeapAlloc(hp,HEAP_ZERO_MEMORY,3);
    h2=HeapAlloc(hp,HEAP_ZERO_MEMORY,5);
    h3=HeapAlloc(hp,HEAP_ZERO_MEMORY,6);
    h4=HeapAlloc(hp,HEAP_ZERO_MEMORY,8);
    h5=HeapAlloc(hp,HEAP_ZERO_MEMORY,19);
    h6=HeapAlloc(hp,HEAP_ZERO_MEMORY,24);

    //free block and prevent coaleses
    HeapFree(hp,0,h1);//free to freelist[2]
    HeapFree(hp,0,h3);//free to freelist[2]
    HeapFree(hp,0,h5);//free to freelist[4]

    HeapFree(hp,0,h4);//coalese h3,h4,h5,link the large block to freelist[8]

    return 0;
}
--------------------end-----------------------

ç¼–è¯‘æˆreleaseç‰ˆæœ¬exe
åŒå‡»è¿è¡Œ0dayheap.exe
odé™„åŠ 
f9
alt+eé€‰æ‹©0dayheap.exe
åœ¨00401018çš„call HeapCreateå¤„ä¸‹æ–­

    00401018    FF15 08604000   call dword ptr ds:[&lt;&amp;KERNEL32.HeapCreate&gt;; kernel32.HeapCreate
    0040101E    8B3D 04604000   mov edi,dword ptr ds:[&lt;&amp;KERNEL32.HeapAll&gt;; ntdll.RtlAllocateHeap
    
åœ¨0dayheap.exeçš„çª—å£ä¸­è¾“å…¥"a",enter
å‘ç°odæ²¡æœ‰æˆåŠŸä¸­æ–­,å¯èƒ½æ˜¯odçš„åŸå› 
alt+v
t
resume all threads
ä¸­æ–­åœ¨401018å¤„
f8
    æ­¤æ—¶eax=3a0000,ä¹Ÿå³heapcreateåˆ›å»ºçš„å †çš„èµ·å§‹åœ°å€ä¸º3a0000
åœ¨å¯„å­˜å™¨çª—å£ä¸­å³é”®eax,åœ¨æ•°æ®çª—å£ä¸­è·Ÿéš

    003A0000  C8 00 00 00 7A 01 00 00 FF EE FF EE 00 10 00 00  ?..z..ï£µ??..
    003A0010  00 00 00 00 00 FE 00 00 00 00 10 00 00 20 00 00  .....?..... ..
    003A0020  00 02 00 00 00 20 00 00 30 01 00 00 FF EF FD 7F  .... ..0..ï£µç¨
    003A0030  05 00 08 06 00 00 00 00 00 00 00 00 00 00 00 00  .............
    003A0040  00 00 00 00 98 05 3A 00 0F 00 00 00 F8 FF FF FF  ....?:....?ï£µï£µ
    003A0050  50 00 3A 00 50 00 3A 00 40 06 3A 00 00 00 00 00  P.:.P.:.@:.....
    003A0060  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    003A0070  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................

alt+mä¹Ÿå¯ä»¥æŸ¥çœ‹å †çš„èµ·å§‹åœ°å€,å¦‚ä¸‹å›¾
</code></pre>
</div>

<p><img src="https://raw.githubusercontent.com/3xp10it/pic/master/heap-2.png" /></p>

<div class="highlighter-rouge"><pre class="highlight"><code>åœ¨003a000é‚£ä¸€è¡Œä¸Šå³é”®å¤åˆ¶ä¸€è¡Œ,ç²˜è´´å¦‚ä¸‹:
    Memory map, æ¡ç›® 15
     åœ°å€=003A0000
     å¤§å°=00001000 (4096.)
     å±ä¸»=         003A0000 (è‡ªèº«)
     åŒºæ®µ=
     ç±»å‹=Priv 00021004
     è®¿é—®=RW
     åˆå§‹è®¿é—®=RW

åœ¨æ•°æ®çª—å£ä¸­çš„003a0000çš„0x178åç§»ä¹Ÿå³3a0178,æ˜¯ç©ºè¡¨ç´¢å¼•,ä¹Ÿå³3a0178æŒ‡å‘freelist,3a0178å¤„çš„å€¼ä¸ºfreelistçš„ç¬¬ä¸€é¡¹å†…å®¹,å¦‚ä¸‹:
    
    003A0170  00 00 00 00 00 00 00 00      88 06 3A 00 88 06 3A 00  ........?:.?:.

    free[0]=0x003a0178
    free[0].flink=[3a0178]=003a0688
    free[0].blink=[3a0178+4]=003a0688

003a0688å¤„çš„æ•°æ®çª—å£å€¼å¦‚ä¸‹:

    003A0688  78 01 3A 00 78 01 3A 00 00 00 00 00 00 00 00 00  x:.x:.........
    003A0698  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................

    free[-1]=0x003a0688
    free[-1].flink=[3a0688]=003a0178    ====free[0]
    free[-1].blink=[3a0688+4]=003a0178
    
    å¯ä»¥çœ‹å‡ºHeapCreateäº§ç”Ÿçš„å †ä¸­çš„ç©ºè¡¨åªæœ‰ä¸¤é¡¹,ä¹Ÿå³åªæœ‰ä¸€ä¸ªå †å—,ä¸”å †å—ç´¢å¼•ä¸ºfree[-1]+8=0x003a0690
    h1=HeapAlloc(hp,HEAP_ZERO_MEMORY,3);//å®é™…åˆ†é…16å­—èŠ‚(2ä¸ªå †å—å¤§å°),é¢„æµ‹h1=0x3a0690
    h2=HeapAlloc(hp,HEAP_ZERO_MEMORY,5);//å®é™…åˆ†é…16å­—èŠ‚(2ä¸ªå †å—å¤§å°),é¢„æµ‹h2=0x3a0690+16=0x3a06a0
    h3=HeapAlloc(hp,HEAP_ZERO_MEMORY,6);//å®é™…åˆ†é…16å­—èŠ‚(2ä¸ªå †å—å¤§å°),é¢„æµ‹h3=0x3a0690+16*2=0x3a06b0
    h4=HeapAlloc(hp,HEAP_ZERO_MEMORY,8);//å®é™…åˆ†é…16å­—èŠ‚(2ä¸ªå †å—å¤§å°),é¢„æµ‹h4=0x3a0690+16*3=0x3a06c0
    h5=HeapAlloc(hp,HEAP_ZERO_MEMORY,19);//å®é™…åˆ†é…32å­—èŠ‚(4ä¸ªå †å—å¤§å°),é¢„æµ‹h5=0x3a0690+16*4=0x3a06d0
    h6=HeapAlloc(hp,HEAP_ZERO_MEMORY,24);//å®é™…åˆ†é…32å­—èŠ‚(4ä¸ªå †å—å¤§å°),é¢„æµ‹h6=0x3a0690+16*4+32=0x3a06f0
    h1-h6å…±åˆ†é…128ä¸ªå­—èŠ‚,128/8=16ä¸ªå †å•å…ƒ

åœ¨å…­å¤„HeapAllocä¸Šä¸‹æ–­

    00401018    FF15 08604000   call dword ptr ds:[&lt;&amp;KERNEL32.HeapCreate&gt;]          ; kernel32.HeapCreate
    0040101E    8B3D 04604000   mov edi,dword ptr ds:[&lt;&amp;KERNEL32.HeapAlloc&gt;]        ; ntdll.RtlAllocateHeap
    00401024    8BF0            mov esi,eax
    00401026    6A 03           push 0x3
    00401028    6A 08           push 0x8
    0040102A    56              push esi
    0040102B    FFD7            call edi     --------&gt;f2
    0040102D    6A 05           push 0x5
    0040102F    6A 08           push 0x8
    00401031    56              push esi
    00401032    8BD8            mov ebx,eax
    00401034    FFD7            call edi     --------&gt;f2
    00401036    6A 06           push 0x6
    00401038    6A 08           push 0x8
    0040103A    56              push esi
    0040103B    FFD7            call edi     --------&gt;f2
    0040103D    6A 08           push 0x8
    0040103F    6A 08           push 0x8
    00401041    56              push esi
    00401042    8BE8            mov ebp,eax
    00401044    FFD7            call edi     --------&gt;f2
    00401046    6A 13           push 0x13
    00401048    6A 08           push 0x8
    0040104A    56              push esi
    0040104B    894424 20       mov dword ptr ss:[esp+0x20],eax
    0040104F    FFD7            call edi     --------&gt;f2
    00401051    6A 18           push 0x18
    00401053    6A 08           push 0x8
    00401055    56              push esi
    00401056    894424 1C       mov dword ptr ss:[esp+0x1C],eax
    0040105A    FFD7            call edi     --------&gt;f2

f8
f8
..
(eip=0x40102d)
    åˆ°40102då¤„eax=0x3a0688,ä¹Ÿå³h1=0x3a0688,è¯´æ˜é¢„æµ‹é”™äº†,å› ä¸ºåˆ†é…ä¸Šé¢å”¯ä¸€çš„å †å—(free[-1]=003a0688)åˆ†é…ä»¥åå°±ä¸
    å†æ˜¯ç©ºé—²å †å—äº†,å˜æˆå ç”¨æ€çš„å †å—,å ç”¨æ€çš„å †å—æ˜¯æ²¡æœ‰flinkå’Œblikçš„,ä¹Ÿå³å ç”¨æ€çš„å †å—çš„ç´¢å¼•ä¸å±äºç©ºè¡¨ä¸­,å±äº
    åº”ç”¨ç¨‹åº.ä¸Šé¢å”¯ä¸€çš„å †å—åˆ†å‰²ä»¥åçš„å †å—æ˜¯åœ¨0x3a0688å¤„å‰²ä¸‹16ä¸ªå­—èŠ‚(h1çš„å¤§å°)åå‰©ä¸‹çš„å”¯ä¸€çš„å †å—
    ç°åœ¨0x3a688å¤„çš„æ•°æ®å¦‚ä¸‹:
        
    003A0688  00 00 00 00 78 01 3A 00 2E 01 02 00 00 10 00 00  ....x:......
    003A0698  78 01 3A 00 78 01 3A 00 00 00 00 00 00 00 00 00  x:.x:.........

    é‡æ–°é¢„æµ‹:
    h1=003a0688
        h1å †å—çš„å—é¦–åœ¨h1-8=3a0680å¤„:
        003A0680:
        02 00 08 00 AA 01 0D 00          ..?..
        å—é¦–çš„å‰2ä¸ªå­—èŠ‚å¯¹åº”å½“å‰å †å—çš„å¤§å°(å †å—çš„ä¸ªæ•°,æ¯ä¸ªå †å—å•ä½ä¸º8å­—èŠ‚å¤§å°),ç¬¬3-4ä¸ªå­—èŠ‚å¯¹åº”å‰ä¸€ä¸ªå †å—å¤§å°,è¿™
        é‡Œå‰2ä¸ªå­—èŠ‚ä¸º0002,ä¹Ÿå³å½“å‰å †å—å¤§å°ä¸º2ä¸ªå †å—,ç¬¬3-4å­—èŠ‚ä¸º0008,å³å‰ä¸€ä¸ªå †å—å¤§å°ä¸º8ä¸ªå †å—
    h2=003a0698
    h3=003a06a8
    h4=003a06b8
    h5=003a06c8
    h6=003a06e8

f8
f8
...
(eip=00401036)
    åˆ°00401036å¤„eax=3a0698,ä¹Ÿå³h2=0x3a0698ä¸é¢„æµ‹ç»“æœä¸€è‡´,h2å †å—çš„å—é¦–åœ¨h2-8=3a0690å¤„:
    003a0690:
    02 00 02 00 A8 01 0B 00          ..?.
    å‰2ä¸ªå­—èŠ‚ä¸º0002,ä¹Ÿå³å½“å‰å †å—å¤§å°ä¸º2,3-4ä¸ªå­—èŠ‚ä¸º0002,ä¹Ÿå³å‰ä¸€ä¸ªå †å—å¤§å°ä¸º2
    æ­¤æ—¶(h1,h2åˆ†é…å®Œæˆ,h3è¿˜æœªåˆ†é…)å¯¹åº”çš„ç©ºé—²å †å—ç´¢å¼•(free[-1])ä¸ºh2+8+8=003a06a0+8=003a06a8,å…¶ä¸­003a06a0ä¸ºç©ºé—²
    å †å—å—é¦–çš„åœ°å€,ç©ºé—²å †å—çš„ç´¢å¼•ä¸ºå—é¦–+8å¤„,å…·ä½“å¦‚ä¸‹:

    003A0698  00 00 00 00 00 01 3A 00 2C 01 02 00 00 10 00 00  .....:.,....
    003A06A8  78 01 3A 00 78 01 3A 00 00 00 00 00 00 00 00 00  x:.x:.........
    003A06B8  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    ä¹Ÿå³ç©ºé—²å †å—çš„å—é¦–ä¸º2c 01 02 00 00 10 00 00==&gt;å½“å‰ç©ºé—²å †å—å¤§å°ä¸º012c,å‰ä¸€ä¸ªå †å—å¤§å°ä¸º2
    æ­¤æ—¶çš„free[-1]=3a06a8,free[-1].flink=[3a06a8]=free[-1].blink=[3a06b0]=003a0178,ä¾ç„¶ä¸ºfree[0]

f8
f8
...
(eip=0040103D)
    åˆ°0040103Då¤„eax=3a06a8,ä¹Ÿå³h3=0x3a06a8ä¸é¢„æµ‹ç»“æœä¸€è‡´,h3å †å—çš„å—é¦–åœ¨h3-8=3a06a0å¤„:
    003A06A0  02 00 02 00 AE 01 0A 00 00 00 00 00 00 00 3A 00  ..?........:.
    å‰2ä¸ªå­—èŠ‚ä¸º0002,ä¹Ÿå³å½“å‰å †å—çš„å¤§å°ä¸º2,3-4ä¸ªå­—èŠ‚ä¸º0002,ä¹Ÿå³å‰ä¸€ä¸ªå †å—å¤§å°ä¸º2
    æ­¤æ—¶(h1,h2,h3åˆ†é…å®Œæˆ,h4è¿˜æ²¡åˆ†é…)å¯¹åº”çš„ç©ºé—²å †å—ç´¢å¼•(free[-1])ä¸ºh3+8+8=3a06b0+8=3a06b8,å…¶ä¸­003a06b0ä¸ºç©ºé—²å †
    å—å—é¦–çš„åœ°å€,ç©ºé—²å †å—çš„ç´¢å¼•ä¸ºå—é¦–+8å¤„,å…·ä½“å¦‚ä¸‹:
    003A06B0  2A 01 02 00 00 10 00 00 78 01 3A 00 78 01 3A 00  *....x:.x:.
    å½“å‰ç©ºé—²å †å—å¤§å°ä¸º012c-2=012a,å‰ä¸€ä¸ªå †å—å¤§å°ä¸º2
    åŒæ ·æ˜¯free[-1].flink=free[-1].blink=003a0178=free[0]

f8
f8
...
(eip=00401046)
    åˆ°00401046å¤„eax=3a06b8,ä¹Ÿå³h4=0x3a06b8ä¸é¢„æµ‹ç»“æœä¸€è‡´,h4å †å—çš„å—é¦–åœ¨h4-8=30a6b0å¤„:
    003A06B0  02 00 02 00 AC 01 08 00 00 00 00 00 00 00 00 00  ..?.........
    å½“å‰å †å—å¤§å°ä¸º2,å‰ä¸€ä¸ªå †å—å¤§å°ä¸º2
    h4åˆ†é…å®Œ,h5è¿˜æ²¡åˆ†é…,ç©ºé—²å †å—ç´¢å¼•(free[-1])ä¸ºh4+8+8=30a6c0+8=30a6c8
    æ•°æ®å¦‚ä¸‹:
    003A06C0  28 01 02 00 00 10 00 00 78 01 3A 00 78 01 3A 00  (....x:.x:.
    å½“å‰ç©ºé—²å †å—çš„å¤§å°ä¸º012a-2=0128,å‰ä¸€ä¸ªå †å—å¤§å°ä¸º2
    åŒæ ·æ˜¯free[-1].flink=free[-1].blink=003a0178=free[0]

f8
f8
...
(eip=00401051)
    åˆ°00401051å¤„eax=3a06c8,ä¹Ÿå³h5=0x3a06c8ä¸é¢„æµ‹ç»“æœä¸€è‡´,h5å †å—çš„å—é¦–åœ¨h5-8=3a06c0å¤„:
    003A06C0  04 00 02 00 A2 01 0D 00 00 00 00 00 00 00 00 00  ..?..........
    å½“å‰å †å—çš„å¤§å°ä¸º4,å‰ä¸€ä¸ªå †å—å¤§å°ä¸º2

f8
f8
...
(eip=0040105c)
    åˆ°0040105cå¤„eax=3a06e8,ä¹Ÿå³h6=0x3a06e8ä¸é¢„æµ‹ç»“æœä¸€è‡´,h6å †å—çš„å—é¦–åœ¨h6-8=3a06e0å¤„:
    003A06E0  04 00 04 00 A6 01 08 00 00 00 00 00 00 00 00 00  ..?.........
    å½“å‰å †å—å¤§å°ä¸º4,å‰ä¸€å †å—å¤§å°ä¸º4
    h6åˆ†é…å®Œ,ç©ºé—²å †å—ç´¢å¼•(free[-1])ä¸ºh6+8*3+8=3a0700+8=3a0708
    æ•°æ®å¦‚ä¸‹:
    003A0700  20 01 04 00 00 10 00 00 78 01 3A 00 78 01 3A 00   ....x:.x:.
    å½“å‰ç©ºé—²å †å—çš„å¤§å°ä¸º0128-4-4=0120,å‰ä¸€ä¸ªå †å—å¤§å°ä¸º4
    åŒæ ·æ˜¯free[-1].flink=free[-1].blink=003a0178=free[0]


åœ¨ä¸‹é¢çš„3ä¸ªå †å—é‡Šæ”¾(call heapfree,é‡Šæ”¾h1,h3,h5,h4)çš„å‡½æ•°ä¸‹æ–­

    0040105C    8B3D 00604000   mov edi,dword ptr ds:[&lt;&amp;KERNEL32.HeapFree&gt;]         ; ntdll.RtlFreeHeap
    00401062    53              push ebx
    00401063    6A 00           push 0x0
    00401065    56              push esi
f2  00401066    FFD7            call edi                                            ; ntdll.RtlAllocateHeap
    00401068    55              push ebp
    00401069    6A 00           push 0x0
    0040106B    56              push esi
f2  0040106C    FFD7            call edi                                            ; ntdll.RtlAllocateHeap
    0040106E    8B4424 10       mov eax,dword ptr ss:[esp+0x10]
    00401072    50              push eax
    00401073    6A 00           push 0x0
    00401075    56              push esi
f2  00401076    FFD7            call edi                                            ; ntdll.RtlAllocateHeap
    00401078    8B4C24 14       mov ecx,dword ptr ss:[esp+0x14]
    0040107C    51              push ecx                                            ; ntdll.7C9301BB
    0040107D    6A 00           push 0x0
    0040107F    56              push esi
    00401080    FFD7            call edi                                            ; ntdll.RtlAllocateHeap
    00401082    5F              pop edi                                             ; 00320036
    00401083    5E              pop esi                                             ; 00320036
    00401084    5D              pop ebp                                             ; 00320036
    00401085    33C0            xor eax,eax
    00401087    5B              pop ebx                                             ; 00320036
    00401088    83C4 08         add esp,0x8
    0040108B    C3              retn

f8
f8
...
(eip=401068)
    åˆ°401068å¤„,h1å †å—è¢«é‡Šæ”¾,ç”±äºh1å®é™…åˆ†é…å¤§å°ä¸º2ä¸ªå †å•å…ƒå¤§å°(2*8=16å­—èŠ‚),é‡Šæ”¾åå°†é“¾å…¥free[2]è¿™ä¸ªç©ºé—²é“¾è¡¨ä¸­
    ,åœ¨h1é‡Šæ”¾ä¹‹å‰åªæœ‰free[0]è¿™ä¸€ä¸ªç©ºé—²é“¾è¡¨,h1é‡Šæ”¾åä¼šå¢åŠ ä¸€ä¸ªç©ºé—²é“¾è¡¨free[2],æ­¤æ—¶free[2]è¿™ä¸ªç©ºè¡¨åªæœ‰ä¸€ä¸ªç»“ç‚¹,æ­¤
    æ—¶free[0]é™„è¿‘æ•°æ®:

    eip=40105cæ—¶,ä¹Ÿå³ä¸Šé¢é‡Šæ”¾h1ä¹‹å‰,free[0]=3a0178,é™„è¿‘çš„æ•°æ®å¦‚ä¸‹:

    003A0170  00 00 00 00 00 00 00 00 08 07 3A 00 08 07 3A 00  ........:.:.
    003A0180  80 01 3A 00 80 01 3A 00 88 01 3A 00 88 01 3A 00  â‚¬:.â‚¬:.?:.?:.
    003A0190  90 01 3A 00 90 01 3A 00 98 01 3A 00 98 01 3A 00  ?:.?:.?:.?:.
    003A01A0  A0 01 3A 00 A0 01 3A 00 A8 01 3A 00 A8 01 3A 00  ?:.?:.?:.?:.
    003A01B0  B0 01 3A 00 B0 01 3A 00 B8 01 3A 00 B8 01 3A 00  ?:.?:.?:.?:.
    003A01C0  C0 01 3A 00 C0 01 3A 00 C8 01 3A 00 C8 01 3A 00  ?:.?:.?:.?:.
    003A01D0  D0 01 3A 00 D0 01 3A 00 D8 01 3A 00 D8 01 3A 00  ?:.?:.?:.?:.
    003A01E0  E0 01 3A 00 E0 01 3A 00 E8 01 3A 00 E8 01 3A 00  ?:.?:.?:.?:.
    003A01F0  F0 01 3A 00 F0 01 3A 00 F8 01 3A 00 F8 01 3A 00  ?:.?:.?:.?:.
    
    ç°åœ¨,eip=401068æ—¶,åˆšé‡Šæ”¾å®Œh1,free[0]=3a0178,é™„è¿‘æ•°æ®å¦‚ä¸‹:

    003A0170  00 00 00 00 00 00 00 00 08 07 3A 00 08 07 3A 00  ........:.:.
    003A0180  80 01 3A 00 80 01 3A 00(88 06 3A 00 88 06 3A 00) â‚¬:.â‚¬:.?:.?:.
    003A0190  90 01 3A 00 90 01 3A 00 98 01 3A 00 98 01 3A 00  ?:.?:.?:.?:.
    003A01A0  A0 01 3A 00 A0 01 3A 00 A8 01 3A 00 A8 01 3A 00  ?:.?:.?:.?:.
    003A01B0  B0 01 3A 00 B0 01 3A 00 B8 01 3A 00 B8 01 3A 00  ?:.?:.?:.?:.
    003A01C0  C0 01 3A 00 C0 01 3A 00 C8 01 3A 00 C8 01 3A 00  ?:.?:.?:.?:.
    003A01D0  D0 01 3A 00 D0 01 3A 00 D8 01 3A 00 D8 01 3A 00  ?:.?:.?:.?:.
    003A01E0  E0 01 3A 00 E0 01 3A 00 E8 01 3A 00 E8 01 3A 00  ?:.?:.?:.?:.
    003A01F0  F0 01 3A 00 F0 01 3A 00 F8 01 3A 00 F8 01 3A 00  ?:.?:.?:.?:.
    
    ä¸åŒä¹‹å¤„æ˜¯3a0188å’Œ3a018cå¤„çš„003a0188å˜æˆäº†003a0688,è€Œ003a0688æ­£æ˜¯h1çš„å€¼,è€Œh1é‡Šæ”¾åå°†é“¾å…¥free[2]çš„ç©ºè¡¨,è¯´æ˜
    3a0188æ­£æ˜¯free[2]è¿™ä¸ªä½ç½®,é‚£ä¹ˆ3a0180å°±æ˜¯free[1]çš„ä½ç½®,ä¹Ÿå³ä»+0x178å¼€å§‹,æœ‰128ä¸ªå…ƒç´ ,æ¯ä¸ª8å­—èŠ‚å¤§å°,è¿™
    128ä¸ªå…ƒç´ æ„æˆä¸€ä¸ªæŒ‡é’ˆæ•°ç»„,è¿™ä¸ªæ•°ç»„å«åš"ç©ºè¡¨ç´¢å¼•",è¿™ä¸ªæ•°ç»„çš„æ¯ä¸€é¡¹åŒ…æ‹¬ä¸¤ä¸ªæŒ‡é’ˆ,æŒ‡é’ˆä»£è¡¨å¯¹åº”ç©ºè¡¨çš„ç¬¬ä¸€ä¸ªç©º
    é—²å †å—çš„å†…å­˜åœ°å€.

f8
f8
...
(eip=40106e)
    åˆ°è¿™é‡Œh3é‡Šæ”¾å®Œ,ç”±äºh3ä¹Ÿæ˜¯ä¸¤ä¸ªå †å—å•å…ƒå¤§å°,æ‰€ä»¥h3ä¹Ÿå°†é“¾å…¥åˆ°free[2]çš„ç©ºè¡¨å½“ä¸­
    å¯ä»¥é¢„æµ‹:
    free[2]å¤„çš„003a0688(free[2]çš„ç¬¬ä¸€ä¸ªç©ºé—²å †å—çš„ç´¢å¼•)å¯¹åº”çš„å†…å­˜å€¼[003a0688]=h3=003a06a8,è€Œ
    [003a0688+4]=free[2]=3a0188,è€Œ[003a06a8]=free[2]=003a0188,[003a06a8+4]=003a0688,free[2]ä¸º3a0188,h3é‡Šæ”¾å
    [3a0188]=3a0688,[3a0188+4]=3a06a8

    å®é™…ç¡®å®å¦‚æ­¤,å®é™…æ•°æ®å¦‚ä¸‹:

    003A0680  02 00 08 00 AA 00 0D 00 A8 06 3A 00 88 01 3A 00  ..?..?:.?:.

    003A06A0  02 00 02 00 AE 00 0A 00 88 01 3A 00 88 06 3A 00  ..?..?:.?:.

    003A0180  80 01 3A 00 80 01 3A 00 88 06 3A 00 A8 06 3A 00  â‚¬:.â‚¬:.?:.?:.

    å¦‚ä¸‹å›¾:
</code></pre>
</div>
<p><img src="https://raw.githubusercontent.com/3xp10it/pic/master/heap-3.png" /></p>

<div class="highlighter-rouge"><pre class="highlight"><code>f8
f8
...
(eip=401078)
    åˆ°è¿™é‡Œh5é‡Šæ”¾å®Œ,ç”±äºh5å®é™…åˆ†é…å¤§å°ä¸º4ä¸ªå †å—å•å…ƒå¤§å°,h5å †å—é‡Šæ”¾åå°†é“¾å…¥free[4]ç©ºè¡¨ä¸­,free[4]=3a0198
    å¯ä»¥é¢„æµ‹:
    [3a0198]=h5=003a06c8,[3a0198+4]=h5=003a06c8
    [003a06c8]=3a0198,[003a06c8+4]=3a0198
    
    å®é™…æ•°æ®å¦‚ä¸‹:

    003A0190  90 01 3A 00 90 01 3A 00 C8 06 3A 00 C8 06 3A 00  ?:.?:.?:.?:.

    003A06C0  04 00 02 00 A2 00 0D 00 98 01 3A 00 98 01 3A 00  ..?..?:.?:.
    ä¸é¢„æµ‹ç»“æœä¸€è‡´

f8
f8
...
(eip=401082)
    åˆ°è¿™é‡Œh4é‡Šæ”¾å®Œ,ç”±äºh4å®é™…åˆ†é…å¤§å°ä¸º2ä¸ªå †å—å•å…ƒå¤§å°,h4å †å—é‡Šæ”¾åå°†é“¾å…¥free[2]ç©ºè¡¨ä¸­,free[2]=3a0188
    å¯ä»¥é¢„æµ‹:
    [free[2]]=[3a0188]=h1=3a0688,[3a0188+4]=h4=3a06b8
    [h1]=[3a0688]=h3=3a06a8,[3a0688+4]=free[2]=3a0188
    [h3]=[3a06a8]=h4=3a06b8,[3a06a8+4]=h1=3a0688
    [h4]=[3a06b8]=3a0188,[3a06b8+4]=h3=3a06a8

    å®é™…æ•°æ®å¦‚ä¸‹:

    003A06B0  02 00 02 00 AC 01 08 00 00 00 00 00 00 00 00 00  ..?.........

    003A0180  80 01 3A 00 80 01 3A 00 88 06 3A 00 88 06 3A 00  â‚¬:.â‚¬:.?:.?:.

    003A0680  02 00 08 00 AA 00 0D 00 88 01 3A 00 88 01 3A 00  ..?..?:.?:.

    003A06A0  08 00 02 00 AE 00 0A 00 B8 01 3A 00 B8 01 3A 00  ..?..?:.?:.

    ä¸å®é™…æ•°æ®å¹¶ä¸ä¸€è‡´,å› ä¸ºh4é‡Šæ”¾å®Œå,h3,h4,h5ä¸‰ä¸ªç©ºé—²å †å—ç›¸é‚»,ä¼šå‘ç”Ÿåˆå¹¶,3ä¸ªå †å—å¤§å°ä¸€å…±ä¸º2+2+4=8ä¸ªå †å•å…ƒå¤§å°,
    åˆå¹¶åå°†é“¾å…¥free[8]ç©ºè¡¨ä¸­(free[8]æ˜¯128ä¸ªç©ºè¡¨ä¸­çš„ç¬¬9ä¸ªç©ºè¡¨çš„ç´¢å¼•,ä¹Ÿå³0x3a0000+0x178+8*8=0x3a01b8)
    ,é¢„æµ‹:
    [free[8]]=[3a01b8]=h3=3a06a8(h3,h4,h5åˆå¹¶åç”±h3ç´¢å¼•)
    [free[2]]=[3a0188]=h1=3a0688(2ä¸ªå †å—å•å…ƒå¤§å°çš„ç©ºé—²å †åªå‰©ä¸‹h1,åŸæ¥æ˜¯h1,h3,h4)
    [h1]=[3a0688]=free[2]=3a0188,[h1+4]=[3a0688+4]=free[2]=3a0188
    [h3]=[3a06a8]=free[8]=3a01b8,[h3+4]=[3a06a8+4]=free[8]=3a01b8

    å®é™…æ•°æ®å¦‚ä¸‹:

    003A01B0  B0 01 3A 00 B0 01 3A 00 A8 06 3A 00 A8 06 3A 00  ?:.?:.?:.?:.

    003A0180  80 01 3A 00 80 01 3A 00 88 06 3A 00 88 06 3A 00  â‚¬:.â‚¬:.?:.?:.

    003A0680  02 00 08 00 AA 00 0D 00 88 01 3A 00 88 01 3A 00  ..?..?:.?:.

    003A06A0  08 00 02 00 AE 00 0A 00 B8 01 3A 00 B8 01 3A 00  ..?..?:.?:.

    å¯è§,å®é™…æ•°æ®ä¸é¢„æµ‹ç»“æœå®Œå…¨ä¸€æ ·,æ­¤æ—¶[free[0]]=[0x3a0178]=3a0708(ä¸€ç›´ä¸å˜),3a0708å¤„æ•°æ®å¦‚ä¸‹:
    003A0700  20 01 04 00 00 10 00 00 78 01 3A 00 78 01 3A 00   ....x:.x:.
    å¯è§å½“å‰å †å—å¤§å°ä¸º0x120(ä¸ªå †å—å•å…ƒå¤§å°),ä¸Šä¸€ä¸ªå †å—å¤§å°ä¸º4?
    å¹¶ä¸æ˜¯è¿™æ ·,å› ä¸º0x178åç§»å¤„å¹¶ä¸æ˜¯å †å—,è€Œæ˜¯å¤§å°ä¸º128çš„æŒ‡é’ˆæ•°ç»„ä¸­çš„ç¬¬ä¸€ä¸ªæ•°ç»„çš„ä½ç½®,æ‰€ä»¥0x178-8å¹¶ä¸æ˜¯å—é¦–
    ,åç§»0x178æ˜¯free[0],ä¹Ÿå³free[0]=0x3a0178,è€Œåç§»0x178ä¸­å­˜æ”¾çš„å†…å®¹ä¹Ÿå³[free[0]]ä¸ºè¿™ä¸ªæŒ‡é’ˆæ•°ç»„ä¸­çš„ç¬¬ä¸€ä¸ªå…ƒç´ 
    çš„å€¼,è¿™ä¸ªå€¼æ˜¯ä¸ªæŒ‡é’ˆ,æŒ‡å‘free[0]ç©ºè¡¨ä¸­çš„ç¬¬ä¸€ä¸ªå †å—,æ­¤ä¾‹ä¸­free[0]ç©ºè¡¨åªæœ‰ä¸€ä¸ªå †å—,å †å—çš„ç´¢å¼•ä¸º3a0708,ä¹Ÿå³:
    [free[0]]=[3a0178]=3a0708,ä¸”[free[0]+4]=[3a0178+4]=3a0708
    è€Œ[3a0708]=[3a0708+4]=3a0178

ä½¿ç”¨å †çš„ä¸‰ç§æ–¹æ³•:
    a&gt;GetProcessHeapè·å¾—è¿›ç¨‹é»˜è®¤å †å¥æŸ„,HeapAlloc(è¿›ç¨‹é»˜è®¤å¥æŸ„)å¯ä»¥ä»é»˜è®¤å †ä¸Šåˆ†é…ç©ºé—´
    b&gt;å½¢å¦‚HeapCreate(0,0x1000,0x10000)åˆ›å»ºä¸å¯æ‰©å±•å †,å †å°†å¯ç”¨ç©ºè¡¨,HeapAllocä»å †ä¸Šåˆ†é…ç©ºé—´
    c&gt;å½¢å¦‚HeapCreate(0,0,0)åˆ›å»ºå¯æ‰©å±•å †,å †å°†å¯ç”¨å¿«è¡¨,HeapAllocä»å †ä¸Šåˆ†é…ç©ºé—´

    åœ¨æ­¤ä¾‹ä¸­,ç”±äºåœ¨åˆ›å»ºå †æ—¶ä½¿ç”¨çš„æ–¹æ³•æ˜¯HeapCreate(0,0x1000,0x10000),å¦‚æœä½¿ç”¨çš„æ–¹æ³•æ˜¯HeapCreate(0,0,0)å°†åˆ›å»ºå¯
    æ‰©å±•çš„å †,è¿™æ—¶å †ä¼šå¯ç”¨å¿«è¡¨,æŒ‡å‘å¿«è¡¨çš„æŒ‡é’ˆä½äºå †åç§»??å­—èŠ‚å¤„,0day2ä¹¦ä¸­åŒæ—¶æŒ‡å‡ºå¿«è¡¨ä½äº0x584å’Œ0x688åç§»å¤„,é€š
    è¿‡ä¸‹é¢ä»£ç çš„è°ƒè¯•æŸ¥çœ‹å¿«è¡¨çš„åç§»åœ¨å“ªé‡Œ:

    -----------find-lookaside---------------
    #include &lt;windows.h&gt;
    int main()
    {
    	HANDLE hp;
    	HLOCAL h1,h2,h3;
    	hp=HeapCreate(0,0,0);
    	h1=HeapAlloc(hp,HEAP_ZERO_MEMORY,3);
    	h2=HeapAlloc(hp,HEAP_ZERO_MEMORY,5);
    	h3=HeapAlloc(hp,HEAP_ZERO_MEMORY,6);
    	getchar();
    	HeapFree(hp,0,h1);
    	HeapFree(hp,0,h1);
    	HeapFree(hp,0,h1);
    
    	return 0;
    
    }
    ------------------end-------------------
    ç¼–è¯‘æˆreleaseç‰ˆæœ¬å,è¿è¡Œexe,windbgåŠ è½½
    dt _PEB @$pebæŸ¥çœ‹è¿›ç¨‹ç¯å¢ƒå—ä¿¡æ¯

    0:001&gt; dt _PEB @$peb
    ntdll!_PEB
       +0x000 InheritedAddressSpace : 0 ''
       +0x001 ReadImageFileExecOptions : 0 ''
       +0x002 BeingDebugged    : 0x1 ''
       +0x003 SpareBool        : 0 ''
       +0x004 Mutant           : 0xffffffff 
       +0x008 ImageBaseAddress : 0x00400000 
       +0x00c Ldr              : 0x00241e90 _PEB_LDR_DATA
       +0x010 ProcessParameters : 0x00020000 _RTL_USER_PROCESS_PARAMETERS
       +0x014 SubSystemData    : (null) 
       +0x018 ProcessHeap      : 0x00140000     ===&gt;è¿›ç¨‹å¯åŠ¨åˆ›å»ºçš„é»˜è®¤å †
       +0x01c FastPebLock      : 0x7c99d600 _RTL_CRITICAL_SECTION
       +0x020 FastPebLockRoutine : 0x7c921000 
       +0x024 FastPebUnlockRoutine : 0x7c9210e0 
       +0x028 EnvironmentUpdateCount : 1
       +0x02c KernelCallbackTable : (null) 
       +0x030 SystemReserved   : [1] 0
       +0x034 AtlThunkSListPtr32 : 0
       +0x038 FreeList         : (null) 
       +0x03c TlsExpansionCounter : 0
       +0x040 TlsBitmap        : 0x7c99d5c0 
       +0x044 TlsBitmapBits    : [2] 1
       +0x04c ReadOnlySharedMemoryBase : 0x7f6f0000 
       +0x050 ReadOnlySharedMemoryHeap : 0x7f6f0000 
       +0x054 ReadOnlyStaticServerData : 0x7f6f0688  -&gt; (null) 
       +0x058 AnsiCodePageData : 0x7ffa0000 
       +0x05c OemCodePageData  : 0x7ffa0000 
       +0x060 UnicodeCaseTableData : 0x7ffd1000 
       +0x064 NumberOfProcessors : 1
       +0x068 NtGlobalFlag     : 0
       +0x070 CriticalSectionTimeout : _LARGE_INTEGER 0xffffe86d`079b8000
       +0x078 HeapSegmentReserve : 0x100000
       +0x07c HeapSegmentCommit : 0x2000
       +0x080 HeapDeCommitTotalFreeThreshold : 0x10000
       +0x084 HeapDeCommitFreeBlockThreshold : 0x1000
       +0x088 NumberOfHeaps    : 5            ===&gt;è¿›ç¨‹ä¸­å…±æœ‰5ä¸ªå †
       +0x08c MaximumNumberOfHeaps : 0x10
       +0x090 ProcessHeaps     : 0x7c99cfc0  -&gt; 0x00140000    ===&gt;è¿›ç¨‹å †æŒ‡é’ˆæ•°æ®
       +0x094 GdiSharedHandleTable : (null) 
       +0x098 ProcessStarterHelper : (null) 
       +0x09c GdiDCAttributeList : 0
       +0x0a0 LoaderLock       : 0x7c99b178 
       +0x0a4 OSMajorVersion   : 5
       +0x0a8 OSMinorVersion   : 1
       +0x0ac OSBuildNumber    : 0xa28
       +0x0ae OSCSDVersion     : 0x300
       +0x0b0 OSPlatformId     : 2
       +0x0b4 ImageSubsystem   : 3
       +0x0b8 ImageSubsystemMajorVersion : 4
       +0x0bc ImageSubsystemMinorVersion : 0
       +0x0c0 ImageProcessAffinityMask : 0
       +0x0c4 GdiHandleBuffer  : [34] 0
       +0x14c PostProcessInitRoutine : (null) 
       +0x150 TlsExpansionBitmap : 0x7c99d5b8 
       +0x154 TlsExpansionBitmapBits : [32] 0
       +0x1d4 SessionId        : 0
       +0x1d8 AppCompatFlags   : _ULARGE_INTEGER 0x0
       +0x1e0 AppCompatFlagsUser : _ULARGE_INTEGER 0x0
       +0x1e8 pShimData        : (null) 
       +0x1ec AppCompatInfo    : (null) 
       +0x1f0 CSDVersion       : _UNICODE_STRING "Service Pack 3"
       +0x1f8 ActivationContextData : (null) 
       +0x1fc ProcessAssemblyStorageMap : (null) 
       +0x200 SystemDefaultActivationContextData : 0x00130000 
       +0x204 SystemAssemblyStorageMap : (null) 
       +0x208 MinimumStackCommit : 0

    +0x018å’Œ+0x088å¤„åˆ†åˆ«ä¸ºè¿›ç¨‹é»˜è®¤å †å’Œè¿›ç¨‹ä¸­å †çš„ä¸ªæ•°
    +0x090å¤„ä¸ºè¿›ç¨‹ä¸­æ‰€æœ‰å †çš„åœ°å€ç»„æˆçš„æŒ‡é’ˆæ•°ç»„

    dd 0x7c99cfc0æŸ¥çœ‹è¿›ç¨‹å †æ•°ç»„
    0:001&gt; dd 0x7c99cfc0
    7c99cfc0  00140000 00240000 00250000 00380000
    7c99cfd0  003a0000 00000000 00000000 00000000
    7c99cfe0  00000000 00000000 00000000 00000000
    7c99cff0  00000000 00000000 00000000 00000000

    æˆ–è€…!heap -hæŸ¥çœ‹æ‰€æœ‰å †çš„åœ°å€
    0:001&gt; !heap -h
    Index   Address  Name      Debugging options enabled
      1:   00140000 
        Segment at 00140000 to 00240000 (00004000 bytes committed)
      2:   00240000 
        Segment at 00240000 to 00250000 (00006000 bytes committed)
      3:   00250000 
        Segment at 00250000 to 00260000 (00003000 bytes committed)
      4:   00380000 
        Segment at 00380000 to 00390000 (00002000 bytes committed)
      5:   003a0000 
        Segment at 003a0000 to 003e0000 (00003000 bytes committed)

    ä¸¤ç§æ–¹æ³•å¾—åˆ°çš„ç»“æœä¸€æ ·,å…¶ä¸­æœ€åä¸€ä¸ªå †çš„åœ°å€0x003a0000æ˜¯ä»£ç ä¸­HeapCreate(0,0,0)åˆ›å»ºå¾—åˆ°çš„å †åœ°å€

    dt _HEAP 0x3a0000æŸ¥çœ‹è¿™ä¸ªå †çš„ç»“æ„
    0:001&gt; dt _HEAP 0x3a0000
    ntdll!_HEAP
       +0x000 Entry            : _HEAP_ENTRY
       +0x008 Signature        : 0xeeffeeff
       +0x00c Flags            : 0x1002
       +0x010 ForceFlags       : 0
       +0x014 VirtualMemoryThreshold : 0xfe00
       +0x018 SegmentReserve   : 0x100000
       +0x01c SegmentCommit    : 0x2000
       +0x020 DeCommitFreeBlockThreshold : 0x200
       +0x024 DeCommitTotalFreeThreshold : 0x2000
       +0x028 TotalFreeSize    : 0x229
       +0x02c MaximumAllocationSize : 0x7ffdefff
       +0x030 ProcessHeapsListIndex : 5
       +0x032 HeaderValidateLength : 0x608
       +0x034 HeaderValidateCopy : (null) 
       +0x038 NextAvailableTagIndex : 0
       +0x03a MaximumTagIndex  : 0
       +0x03c TagEntries       : (null) 
       +0x040 UCRSegments      : (null) 
       +0x044 UnusedUnCommittedRanges : 0x003a0598 _HEAP_UNCOMMMTTED_RANGE
       +0x048 AlignRound       : 0xf
       +0x04c AlignMask        : 0xfffffff8
       +0x050 VirtualAllocdBlocks : _LIST_ENTRY [ 0x3a0050 - 0x3a0050 ]
       +0x058 Segments         : [64] 0x003a0640 _HEAP_SEGMENT
       +0x158 u                : __unnamed
       +0x168 u2               : __unnamed
       +0x16a AllocatorBackTraceIndex : 0
       +0x16c NonDedicatedListLength : 1
       +0x170 LargeBlocksIndex : (null) 
       +0x174 PseudoTagEntries : (null) 
       +0x178 FreeLists        : [128] _LIST_ENTRY [ 0x3a1ec0 - 0x3a1ec0 ]
       +0x578 LockVariable     : 0x003a0608 _HEAP_LOCK
       +0x57c CommitRoutine    : (null) 
       +0x580 FrontEndHeap     : 0x003a0688 
       +0x584 FrontHeapLockCount : 0
       +0x586 FrontEndHeapType : 0x1 ''
       +0x587 LastSegmentIndex : 0 ''

    å¯ä»¥åœ¨0x178åç§»å¤„æ‰¾åˆ°free[0](0å·ç©ºè¡¨)

    dt _LIST_ENTRY 0x3a0178
    ntdll!_LIST_ENTRY
     [ 0x3a1ec0 - 0x3a1ec0 ]
       +0x000 Flink            : 0x003a1ec0 _LIST_ENTRY [ 0x3a0178 - 0x3a0178 ]
       +0x004 Blink            : 0x003a1ec0 _LIST_ENTRY [ 0x3a0178 - 0x3a0178 ]

    dd 0x3a0688
    0:001&gt; dd 0x3a0688
    003a0688  00000000 00000000 01000004 00000000
    003a0698  00000000 00000000 00000000 00000000
    003a06a8  00000000 00000003 00000000 00000000
    003a06b8  00000000 00000000 01000004 00000000

    0x3a0000å †ä¸­èƒ½æ‰¾åˆ°0å·ç©ºè¡¨ä½†æ˜¯å´æ‰¾ä¸åˆ°å¿«è¡¨,0day2ä¸­è¯´çš„0x688å’Œ0x584åç§»å¤„å¹¶ä¸æ˜¯å¿«è¡¨çš„æ‰€åœ¨,å…³äºå¿«è¡¨çš„æ‰€åœ¨å’Œå‡º
    ç°æ¡ä»¶,æš‚æƒ‘ä¸å¾—è§£
</code></pre>
</div>

<h4 id="section">2&gt;æ¼æ´æˆ˜äº‰å®ä¾‹</h4>

<div class="highlighter-rouge"><pre class="highlight"><code>------------------heapoverflow.c---------------------
#include &lt;windows.h&gt;
#include &lt;stdio.h&gt;

int main()
{
    HANDLE hHeap;
    char *heap;
    char str[]="AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA";
    hHeap=HeapCreate(HEAP_GENERATE_EXCEPTIONS,0x1000,0xffff);
    getchar();

    heap=HeapAlloc(hHeap,0,0x10);
    printf("heap addr:0x%08x\n",heap);

    strcpy(heap,str);
    HeapFree(hHeap,0,heap);

    HeapDestroy(hHeap);
    return 0;
}
------------------------end--------------------------
</code></pre>
</div>
</span>

        


        
        <div class="tags">
          <small>
          <i class="fa fa-tags"></i>
            æ¼æ´æˆ˜äº‰, æ¼æ´åˆ†æ, å †æº¢å‡º
          </small>
        </div>
        

      </div>

      
      <div class="content-panel feedback">
        I <i class="fa fa-heart"></i> feedback.<br />
        Let me know what you think of this article on twitter <a href="https://www.twitter.com/quanyechavshuo">@quanyechavshuo</a>!
      </div>
      


      



      
<!-- å¤šè¯´è¯„è®ºæ¡† start -->
<div class="ds-thread" data-thread-key="/%E4%BA%8C%E8%BF%9B%E5%88%B6/2016/08/17/æ¼æ´æˆ˜äº‰-cve-2010-2553" data-title="" data-url="https://3xp10it.github.io//%E4%BA%8C%E8%BF%9B%E5%88%B6/2016/08/17/%E6%BC%8F%E6%B4%9E%E6%88%98%E4%BA%89-cve-2010-2553/"></div>
<!-- å¤šè¯´è¯„è®ºæ¡† end -->
<!-- å¤šè¯´å…¬å…±JSä»£ç  start (ä¸€ä¸ªç½‘é¡µåªéœ€æ’å…¥ä¸€æ¬¡) -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"3xp10it"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
<!-- å¤šè¯´å…¬å…±JSä»£ç  end -->
      


      

    </div>

  </div>

</div>





      </div>
    </div>

    <div class="footer clearfix">
  <div class="col-md-12">
    for better experience please install font æ–‡æ³‰é©¿ç­‰å®½æ­£é»‘
  </div>
</div>

<div class="my-home"><i class="fa fa-home" aria-hidden="true"></i><a href="/index2.html"> <font color="white">home</font></a></div>
<div class="my-papers"><i class="fa fa-github" aria-hidden="true"></i><a href="https://github.com/3xp10it" target="_top"> <font color="white">papers</font></a></div>
<div class="my-search"><i class="fa fa-search" aria-hidden="true"></i><a href="/search/"> <font color="white">search</font></a></div>
<div class="my-archive"><i class="fa fa-apple" aria-hidden="true"></i><a href="/my-archive/"> <font color="white">archive</font></a></div>
<div class="my-categories"><i class="fa fa-tags" aria-hidden="true"></i><a href="/my-categories/"> <font color="white">categories</font></a></div>


<script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
<script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
<script src="/js/jquery.mmenu.min.all.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.7/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script type="text/javascript">
   $(document).ready(function() {
      $("#my-menu").mmenu().on( "closed.mm", function() {
            $(".menu-button").show();
         });
      $(".menu-button").click(function() {
        $(".menu-button").hide();
        $("#my-menu").trigger("open.mm");
      });
   });
</script>






    </body>
</html>
