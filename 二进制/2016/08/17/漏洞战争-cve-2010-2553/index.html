<!DOCTYPE html>
<html>


    <head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ¼æ´æˆ˜äº‰-cve-2010-2553</title>
<meta name="description" content="A blog about programming and network security">

<link rel="profile" href="https://gmpg.org/xfn/11" />
<! -- link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bbbbootstrap.min.css"-- >
<link rel="stylesheet" href="/css/my_code.css">
<link rel="stylesheet" href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css">
<link rel="stylesheet" type="text/css" media="all" href="/css/style.css" />
<link rel="stylesheet" type="text/css" media="all" href="/css/jquery.mmenu.all.css" />
<link rel="stylesheet" href="/css/highlightjs.piperita.css">

<!-- Favicons generated at https://realfavicongenerator.net/ -->
<link rel="apple-touch-icon" sizes="57x57" href="/favicons/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="/favicons/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="/favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="/favicons/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="/favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="/favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="/favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="/favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="/favicons/apple-touch-icon-180x180.png">
<link rel="icon" type="image/png" href="/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="/favicons/android-chrome-192x192.png" sizes="192x192">
<link rel="icon" type="image/png" href="/favicons/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="/favicons/favicon-16x16.png" sizes="16x16">
<link rel="manifest" href="/favicons/manifest.json">
<link rel="shortcut icon" href="/favicons/favicon.ico">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="msapplication-TileImage" content="/favicons/mstile-144x144.png">
<meta name="msapplication-config" content="/favicons/browserconfig.xml">
<meta name="theme-color" content="#ffffff">





</head>


    <body>

    <nav id="my-menu">
  <div>
    <p>quanyechavshuo</p>

    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <br>
    <!--https://fontawesome.io/icons/ -->
    <br>
    <center>
    <font color="red" align="center"><i class="fa fa-link" aria-hidden="true"></i><a href="../../../../../bookmarks.html"><font color="red"> link</font></a></font>
    <br>
    <br>
    <font color="red" align="center"><i class="fa fa-key" aria-hidden="true"></i><a href="../../../../../book.html" target="_top"><font color="red"> book</font></a></font>
    <br>
    <br>
    <font color="red" align="center"><i class="fa fa-music" aria-hidden="true"></i><a href="../../../../../jquery-jplayer/index.html" target="_top"><font color="red"> music</font></a></font>
    <br>
    <br>
    <font color="red" align="center"><i class="fa fa-caret-square-o-right" aria-hidden="true"></i><a href="../../../../../mv.html" target="_top"><font color="red"> movie</font></a></font>
    </center>
    <p class="links">
  <a href="https://www.twitter.com/quanyechavshuo" target="_new"><i class="fa fa-twitter"></i></a>
  <a href="https://github.com/3xp10it" target="_new"><i class="fa fa-github-alt"></i></a>
  <a href="/feed.xml" target="_new"><i class="fa fa-rss"></i></a>
</p>

  </div>
</nav>
<div class="menu-button" href="#menu"><i class="fa fa-bars"></i></div>



    <div class="page-content">
      <div class="wrap">
      

<div class="container-fluid single">
  <div class="row">

    <div itemscope itemtype="https://schema.org/Article" class="col-md-12 article">
      

      <h1 class="header" itemprop="name">æ¼æ´æˆ˜äº‰-cve-2010-2553</h1>

      <div class="author">
        <small><i>
          
          on <span itemprop="datePublished" content="2014-08-28">August 17, 2016</span>
           under äºŒè¿›åˆ¶
        </i></small>
      </div>

      <div class="read-time">
        <small>
          7 minute read
        </small>
      </div>

      <div class="content-panel content">

        

        <span itemprop="articleBody"><h3 id="x00-">0x00 å †æº¢å‡ºåŸºç¡€çŸ¥è¯†</h3>

<div class="highlighter-rouge"><pre class="highlight"><code>1&gt;good link:
    http://blog.csdn.net/ithzhang/article/details/12711431
    http://www.mottoin.com/87277.html
    http://www.voidcn.com/blog/u010797814/article/p-3924286.html

2&gt;å †è¡¨åªç´¢å¼•æ‰€æœ‰çš„ç©ºé—²æ€å †å—,å·²åˆ†é…|å ç”¨çš„å †å—ç”±ä½¿ç”¨å®ƒçš„ç¨‹åºç´¢å¼•,ç©ºé—²æ€å †å—å’Œå ç”¨æ€å †å—:

    å †å—ä½¿ç”¨_HEAP_ENTYRç»“æ„æ¥æè¿°,è¯¥ç»“æ„å 8Byte. _HEAP_ENTRYç»“æ„ä¹‹åå°±æ˜¯ä¾›åº”ç”¨ç¨‹åºä½¿ç”¨çš„åŒºåŸŸ.è°ƒç”¨HeapAllocå‡½æ•°
    å°†è¿”å›HEAP_ENTRYä¹‹åçš„åœ°å€.æ­¤åœ°å€å‡å»8Byteä¾¿å¯ä»¥å¾—åˆ°_HEAP_ENTRYç»“æ„.å¯¹äºå·²ç»é‡Šæ”¾çš„å †å—,å †ç®¡ç†å™¨å®šä¹‰äº†
    _HEAP_FREE_ENTRYç»“æ„æ¥æè¿°.è¯¥ç»“æ„çš„å‰å…«ä¸ªå­—èŠ‚ä¸_HEAP_ENTRYç»“æ„å®Œå…¨ç›¸åŒ.ä½†å¢åŠ äº†8ä¸ªå­—èŠ‚æ¥å­˜å‚¨ç©ºé—²é“¾è¡¨çš„å¤´èŠ‚ç‚¹.
    _HEAP_FREE_ENTRYæ˜¯ç©ºé—²æ€å †å—ä¸­çš„å—é¦–(8byte)ä¸flink,blink(4+4=8)çš„æ€»å’Œ,_HEAP_FREE_ENTRYå…±16byte,_HEAP_ENTRY
    æ˜¯å ç”¨æ€å †å—ä¸­å¯¹åº”çš„å—é¦–çš„ç»“æ„,å¤§å°ä¸º8byte.
    å¦‚ä¸‹å›¾:
</code></pre>
</div>
<p><img src="https://raw.githubusercontent.com/3xp10it/pic/master/heap-1.png" /></p>

<div class="highlighter-rouge"><pre class="highlight"><code>3&gt;å †æº¢å‡ºå®è´¨:
    [flink+4]=blink
    [blink]=flink

    å…¶ä¸­flinkä»£è¡¨ä¸‹ä¸€ä¸ªå †å—çš„ç´¢å¼•ï¼Œblinkä»£è¡¨å‰ä¸€ä¸ªå †å—çš„ç´¢å¼•

4&gt;è°ƒè¯•å †ä¸è°ƒè¯•æ ˆä¸åŒ,ä¸èƒ½ç›´æ¥ç”¨è°ƒè¯•å™¨æ¥åŠ è½½ç¨‹åº,å¦åˆ™å †ç®¡ç†å‡½æ•°ä¼šæ£€æµ‹åˆ°å½“å‰è¿›ç¨‹å¤„äºè°ƒè¯•çŠ¶æ€,è€Œä½¿ç”¨è°ƒè¯•æ€å †ç®¡ç†
  ç­–ç•¥
</code></pre>
</div>

<h3 id="x01-">0x01 å †æº¢å‡ºåŸç†</h3>

<h4 id="day2">1&gt;0day2å®ä¾‹</h4>

<div class="highlighter-rouge"><pre class="highlight"><code>-----------------0dayheap.c-(page:152)--------
#include &lt;windows.h&gt;
int main()
{
    HLOCAL h1,h2,h3,h4,h5,h6;
    HANDLE hp;
    getchar();//å°†ä¹¦ä¸­ä¸‹é¢çš„__asm int 3æ”¹æˆè¿™é‡Œçš„getchar(),å› ä¸ºå®é™…ä¸­å°†odè®¾ä¸ºå®æ—¶è°ƒè¯•æç¤ºæœ‰é—®é¢˜
    hp=HeapCreate(0,0x1000,0x10000);//åˆ›å»ºä¸€ä¸ª0x1000=4096å¤§å°çš„å †
    //__asm int 3,ä¹¦ä¸­æ˜¯__asm int 3,åœ¨winxp sp3ä¸Šæµ‹è¯•ä¸­æ–­æ•ˆæœè¿˜å¥½,æ”¹æˆä¸Šé¢çš„getchar()

    h1=HeapAlloc(hp,HEAP_ZERO_MEMORY,3);
    h2=HeapAlloc(hp,HEAP_ZERO_MEMORY,5);
    h3=HeapAlloc(hp,HEAP_ZERO_MEMORY,6);
    h4=HeapAlloc(hp,HEAP_ZERO_MEMORY,8);
    h5=HeapAlloc(hp,HEAP_ZERO_MEMORY,19);
    h6=HeapAlloc(hp,HEAP_ZERO_MEMORY,24);

    //free block and prevent coaleses
    HeapFree(hp,0,h1);//free to freelist[2]
    HeapFree(hp,0,h3);//free to freelist[2]
    HeapFree(hp,0,h5);//free to freelist[4]

    HeapFree(hp,0,h4);//coalese h3,h4,h5,link the large block to freelist[8]

    return 0;
}
--------------------end-----------------------

ç¼–è¯‘æˆreleaseç‰ˆæœ¬exe
åŒå‡»è¿è¡Œ0dayheap.exe
odé™„åŠ 
f9
alt+eé€‰æ‹©0dayheap.exe
åœ¨00401018çš„call HeapCreateå¤„ä¸‹æ–­

    00401018    FF15 08604000   call dword ptr ds:[&lt;&amp;KERNEL32.HeapCreate&gt;; kernel32.HeapCreate
    0040101E    8B3D 04604000   mov edi,dword ptr ds:[&lt;&amp;KERNEL32.HeapAll&gt;; ntdll.RtlAllocateHeap
    
åœ¨0dayheap.exeçš„çª—å£ä¸­è¾“å…¥"a",enter
å‘ç°odæ²¡æœ‰æˆåŠŸä¸­æ–­,å¯èƒ½æ˜¯odçš„åŸå› 
alt+v
t
resume all threads
ä¸­æ–­åœ¨401018å¤„
f8
    æ­¤æ—¶eax=3a0000,ä¹Ÿå³heapcreateåˆ›å»ºçš„å †çš„èµ·å§‹åœ°å€ä¸º3a0000
åœ¨å¯„å­˜å™¨çª—å£ä¸­å³é”®eax,åœ¨æ•°æ®çª—å£ä¸­è·Ÿéš

    003A0000  C8 00 00 00 7A 01 00 00 FF EE FF EE 00 10 00 00  ?..z..ï£µ??..
    003A0010  00 00 00 00 00 FE 00 00 00 00 10 00 00 20 00 00  .....?..... ..
    003A0020  00 02 00 00 00 20 00 00 30 01 00 00 FF EF FD 7F  .... ..0..ï£µç¨
    003A0030  05 00 08 06 00 00 00 00 00 00 00 00 00 00 00 00  .............
    003A0040  00 00 00 00 98 05 3A 00 0F 00 00 00 F8 FF FF FF  ....?:....?ï£µï£µ
    003A0050  50 00 3A 00 50 00 3A 00 40 06 3A 00 00 00 00 00  P.:.P.:.@:.....
    003A0060  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    003A0070  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................

alt+mä¹Ÿå¯ä»¥æŸ¥çœ‹å †çš„èµ·å§‹åœ°å€,å¦‚ä¸‹å›¾
</code></pre>
</div>

<p><img src="https://raw.githubusercontent.com/3xp10it/pic/master/heap-2.png" /></p>

<div class="highlighter-rouge"><pre class="highlight"><code>åœ¨003a000é‚£ä¸€è¡Œä¸Šå³é”®å¤åˆ¶ä¸€è¡Œ,ç²˜è´´å¦‚ä¸‹:
    Memory map, æ¡ç›® 15
     åœ°å€=003A0000
     å¤§å°=00001000 (4096.)
     å±ä¸»=         003A0000 (è‡ªèº«)
     åŒºæ®µ=
     ç±»å‹=Priv 00021004
     è®¿é—®=RW
     åˆå§‹è®¿é—®=RW

åœ¨æ•°æ®çª—å£ä¸­çš„003a0000çš„0x178åç§»ä¹Ÿå³3a0178,æ˜¯ç©ºè¡¨ç´¢å¼•,ä¹Ÿå³3a0178æŒ‡å‘freelist,3a0178å¤„çš„å€¼ä¸ºfreelistçš„ç¬¬ä¸€é¡¹å†…å®¹,å¦‚ä¸‹:
    
    003A0170  00 00 00 00 00 00 00 00      88 06 3A 00 88 06 3A 00  ........?:.?:.

    free[0]=0x003a0178
    free[0].flink=[3a0178]=003a0688
    free[0].blink=[3a0178+4]=003a0688

003a0688å¤„çš„æ•°æ®çª—å£å€¼å¦‚ä¸‹:

    003A0688  78 01 3A 00 78 01 3A 00 00 00 00 00 00 00 00 00  x:.x:.........
    003A0698  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................

    free[-1]=0x003a0688
    free[-1].flink=[3a0688]=003a0178    ====free[0]
    free[-1].blink=[3a0688+4]=003a0178
    
    å¯ä»¥çœ‹å‡ºHeapCreateäº§ç”Ÿçš„å †ä¸­çš„ç©ºè¡¨åªæœ‰ä¸¤é¡¹,ä¹Ÿå³åªæœ‰ä¸€ä¸ªå †å—,ä¸”å †å—ç´¢å¼•ä¸ºfree[-1]+8=0x003a0690
    h1=HeapAlloc(hp,HEAP_ZERO_MEMORY,3);//å®é™…åˆ†é…16å­—èŠ‚(2ä¸ªå †å—å¤§å°),é¢„æµ‹h1=0x3a0690
    h2=HeapAlloc(hp,HEAP_ZERO_MEMORY,5);//å®é™…åˆ†é…16å­—èŠ‚(2ä¸ªå †å—å¤§å°),é¢„æµ‹h2=0x3a0690+16=0x3a06a0
    h3=HeapAlloc(hp,HEAP_ZERO_MEMORY,6);//å®é™…åˆ†é…16å­—èŠ‚(2ä¸ªå †å—å¤§å°),é¢„æµ‹h3=0x3a0690+16*2=0x3a06b0
    h4=HeapAlloc(hp,HEAP_ZERO_MEMORY,8);//å®é™…åˆ†é…16å­—èŠ‚(2ä¸ªå †å—å¤§å°),é¢„æµ‹h4=0x3a0690+16*3=0x3a06c0
    h5=HeapAlloc(hp,HEAP_ZERO_MEMORY,19);//å®é™…åˆ†é…32å­—èŠ‚(4ä¸ªå †å—å¤§å°),é¢„æµ‹h5=0x3a0690+16*4=0x3a06d0
    h6=HeapAlloc(hp,HEAP_ZERO_MEMORY,24);//å®é™…åˆ†é…32å­—èŠ‚(4ä¸ªå †å—å¤§å°),é¢„æµ‹h6=0x3a0690+16*4+32=0x3a06f0
    h1-h6å…±åˆ†é…128ä¸ªå­—èŠ‚,128/8=16ä¸ªå †å•å…ƒ

åœ¨å…­å¤„HeapAllocä¸Šä¸‹æ–­

    00401018    FF15 08604000   call dword ptr ds:[&lt;&amp;KERNEL32.HeapCreate&gt;]          ; kernel32.HeapCreate
    0040101E    8B3D 04604000   mov edi,dword ptr ds:[&lt;&amp;KERNEL32.HeapAlloc&gt;]        ; ntdll.RtlAllocateHeap
    00401024    8BF0            mov esi,eax
    00401026    6A 03           push 0x3
    00401028    6A 08           push 0x8
    0040102A    56              push esi
    0040102B    FFD7            call edi     --------&gt;f2
    0040102D    6A 05           push 0x5
    0040102F    6A 08           push 0x8
    00401031    56              push esi
    00401032    8BD8            mov ebx,eax
    00401034    FFD7            call edi     --------&gt;f2
    00401036    6A 06           push 0x6
    00401038    6A 08           push 0x8
    0040103A    56              push esi
    0040103B    FFD7            call edi     --------&gt;f2
    0040103D    6A 08           push 0x8
    0040103F    6A 08           push 0x8
    00401041    56              push esi
    00401042    8BE8            mov ebp,eax
    00401044    FFD7            call edi     --------&gt;f2
    00401046    6A 13           push 0x13
    00401048    6A 08           push 0x8
    0040104A    56              push esi
    0040104B    894424 20       mov dword ptr ss:[esp+0x20],eax
    0040104F    FFD7            call edi     --------&gt;f2
    00401051    6A 18           push 0x18
    00401053    6A 08           push 0x8
    00401055    56              push esi
    00401056    894424 1C       mov dword ptr ss:[esp+0x1C],eax
    0040105A    FFD7            call edi     --------&gt;f2

f8
f8
..
(eip=0x40102d)
    åˆ°40102då¤„eax=0x3a0688,ä¹Ÿå³h1=0x3a0688,è¯´æ˜é¢„æµ‹é”™äº†,å› ä¸ºåˆ†é…ä¸Šé¢å”¯ä¸€çš„å †å—(free[-1]=003a0688)åˆ†é…ä»¥åå°±ä¸
    å†æ˜¯ç©ºé—²å †å—äº†,å˜æˆå ç”¨æ€çš„å †å—,å ç”¨æ€çš„å †å—æ˜¯æ²¡æœ‰flinkå’Œblikçš„,ä¹Ÿå³å ç”¨æ€çš„å †å—çš„ç´¢å¼•ä¸å±äºç©ºè¡¨ä¸­,å±äº
    åº”ç”¨ç¨‹åº,å±äºåº”ç”¨ç¨‹åº.ä¸Šé¢å”¯ä¸€çš„å †å—åˆ†å‰²ä»¥åçš„å †å—æ˜¯åœ¨0x3a0688å¤„å‰²ä¸‹16ä¸ªå­—èŠ‚(h1çš„å¤§å°)åå‰©ä¸‹çš„å”¯ä¸€çš„å †å—,
    ç°åœ¨0x3a688å¤„çš„æ•°æ®å¦‚ä¸‹:
        
    003A0688  00 00 00 00 78 01 3A 00 2E 01 02 00 00 10 00 00  ....x:......
    003A0698  78 01 3A 00 78 01 3A 00 00 00 00 00 00 00 00 00  x:.x:.........

    é‡æ–°é¢„æµ‹:
    h1=003a0688
        h1å †å—çš„å—é¦–åœ¨h1-8=3a0680å¤„:
        003A0680:
        02 00 08 00 AA 01 0D 00          ..?..
        å—é¦–çš„å‰2ä¸ªå­—èŠ‚å¯¹åº”å½“å‰å †å—çš„å¤§å°(å †å—çš„ä¸ªæ•°,æ¯ä¸ªå †å—å•ä½ä¸º8å­—èŠ‚å¤§å°),ç¬¬3-4ä¸ªå­—èŠ‚å¯¹åº”å‰ä¸€ä¸ªå †å—å¤§å°,è¿™
        é‡Œå‰2ä¸ªå­—èŠ‚ä¸º0002,ä¹Ÿå³å½“å‰å †å—å¤§å°ä¸º2ä¸ªå †å—,ç¬¬3-4å­—èŠ‚ä¸º0008,å³å‰ä¸€ä¸ªå †å—å¤§å°ä¸º8ä¸ªå †å—
    h2=003a0698
    h3=003a06a8
    h4=003a06b8
    h5=003a06c8
    h6=003a06e8

f8
f8
...
(eip=00401036)
    åˆ°00401036å¤„eax=3a0698,ä¹Ÿå³h2=0x3a0698ä¸é¢„æµ‹ç»“æœä¸€è‡´,h2å †å—çš„å—é¦–åœ¨h2-8=3a0690å¤„:
    003a0690:
    02 00 02 00 A8 01 0B 00          ..?.
    å‰2ä¸ªå­—èŠ‚ä¸º0002,ä¹Ÿå³å½“å‰å †å—å¤§å°ä¸º2,3-4ä¸ªå­—èŠ‚ä¸º0002,ä¹Ÿå³å‰ä¸€ä¸ªå †å—å¤§å°ä¸º2
    æ­¤æ—¶(h1,h2åˆ†é…å®Œæˆ,h3è¿˜æœªåˆ†é…)å¯¹åº”çš„ç©ºé—²å †å—ç´¢å¼•(free[-1])ä¸ºh2+8+8=003a06a0+8=003a06a8,å…¶ä¸­003a06a0ä¸ºç©ºé—²å †å—å—é¦–çš„åœ°
    å€,ç©ºé—²å †å—çš„ç´¢å¼•ä¸ºå—é¦–+8å¤„,å…·ä½“å¦‚ä¸‹:

    003A0698  00 00 00 00 00 01 3A 00 2C 01 02 00 00 10 00 00  .....:.,....
    003A06A8  78 01 3A 00 78 01 3A 00 00 00 00 00 00 00 00 00  x:.x:.........
    003A06B8  00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
    ä¹Ÿå³ç©ºé—²å †å—çš„å—é¦–ä¸º2c 01 02 00 00 10 00 00==&gt;å½“å‰ç©ºé—²å †å—å¤§å°ä¸º012c,å‰ä¸€ä¸ªå †å—å¤§å°ä¸º2
    æ­¤æ—¶çš„free[-1]=3a06a8,free[-1].flink=[3a06a8]=free[-1].blink=[3a06b0]=003a0178,ä¾ç„¶ä¸ºfree[0]

f8
f8
...
(eip=0040103D)
    åˆ°0040103Då¤„eax=3a06a8,ä¹Ÿå³h3=0x3a06a8ä¸é¢„æµ‹ç»“æœä¸€è‡´,h3å †å—çš„å—é¦–åœ¨h3-8=3a06a0å¤„:
    003A06A0  02 00 02 00 AE 01 0A 00 00 00 00 00 00 00 3A 00  ..?........:.
    å‰2ä¸ªå­—èŠ‚ä¸º0002,ä¹Ÿå³å½“å‰å †å—çš„å¤§å°ä¸º2,3-4ä¸ªå­—èŠ‚ä¸º0002,ä¹Ÿå¥½å‰ä¸€ä¸ªå †å—å¤§å°ä¸º2
    æ­¤æ—¶(h1,h2,h3åˆ†é…å®Œæˆ,h4è¿˜æ²¡åˆ†é…)å¯¹åº”çš„ç©ºé—²å †å—ç´¢å¼•(free[-1])ä¸ºh3+8+8=3a06b0+8=3a06b8,å…¶ä¸­003a06b0ä¸ºç©ºé—²å †
    å—å—é¦–çš„åœ°å€,ç©ºé—²å †å—çš„ç´¢å¼•ä¸ºå—é¦–+8å¤„,å…·ä½“å¦‚ä¸‹:
    003A06B0  2A 01 02 00 00 10 00 00 78 01 3A 00 78 01 3A 00  *....x:.x:.
    å½“å‰ç©ºé—²å †å—å¤§å°ä¸º012c-2=012a,å‰ä¸€ä¸ªå †å—å¤§å°ä¸º2
    åŒæ ·æ˜¯free[-1].flink=free[-1].blink=003a0178=free[0]

f8
f8
...
(eip=00401046)
    åˆ°00401046å¤„eax=3a06b8,ä¹Ÿå³h4=0x3a06b8ä¸é¢„æµ‹ç»“æœä¸€è‡´,h4å †å—çš„å—é¦–åœ¨h4-8=30a6b0å¤„:
    003A06B0  02 00 02 00 AC 01 08 00 00 00 00 00 00 00 00 00  ..?.........
    å½“å‰å †å—å¤§å°ä¸º2,å‰ä¸€ä¸ªå †å—å¤§å°ä¸º2
    h4åˆ†é…å®Œ,h5è¿˜æ²¡åˆ†é…,ç©ºé—²å †å—ç´¢å¼•(free[-1])ä¸ºh4+8+8=30a6c0+8=30a6c8
    æ•°æ®å¦‚ä¸‹:
    003A06C0  28 01 02 00 00 10 00 00 78 01 3A 00 78 01 3A 00  (....x:.x:.
    å½“å‰ç©ºé—²å †å—çš„å¤§å°ä¸º012a-2=0128,å‰ä¸€ä¸ªå †å—å¤§å°ä¸º2
    åŒæ ·æ˜¯free[-1].flink=free[-1].blink=003a0178=free[0]

f8
f8
...
(eip=00401051)
    åˆ°00401051å¤„eax=3a06c8,ä¹Ÿå³h5=0x3a06c8ä¸é¢„æµ‹ç»“æœä¸€è‡´,h5å †å—çš„å—é¦–åœ¨h5-8=3a06c0å¤„:
    003A06C0  04 00 02 00 A2 01 0D 00 00 00 00 00 00 00 00 00  ..?..........
    å½“å‰å †å—çš„å¤§å°ä¸º4,å‰ä¸€ä¸ªå †å—å¤§å°ä¸º2

f8
f8
...
(eip=0040105c)
    åˆ°0040105cå¤„eax=3a06e8,ä¹Ÿå³h6=0x3a06e8ä¸é¢„æµ‹ç»“æœä¸€è‡´,h6å †å—çš„å—é¦–åœ¨h6-8=3a06e0å¤„:
    003A06E0  04 00 04 00 A6 01 08 00 00 00 00 00 00 00 00 00  ..?.........
    å½“å‰å †å—å¤§å°ä¸º4,å‰ä¸€å †å—å¤§å°ä¸º4
    h6åˆ†é…å®Œ,ç©ºé—²å †å—ç´¢å¼•(free[-1])ä¸ºh6+8*3+8=3a0700+8=3a0708
    æ•°æ®å¦‚ä¸‹:
    003A0700  20 01 04 00 00 10 00 00 78 01 3A 00 78 01 3A 00   ....x:.x:.
    å½“å‰ç©ºé—²å †å—çš„å¤§å°ä¸º0128-4-4=0120,å‰ä¸€ä¸ªå †å—å¤§å°ä¸º4
    åŒæ ·æ˜¯free[-1].flink=free[-1].blink=003a0178=free[0]


åœ¨ä¸‹é¢çš„3ä¸ªå †å—é‡Šæ”¾(call heapfree,é‡Šæ”¾h1,h3,h5,h4)çš„å‡½æ•°ä¸‹æ–­

    0040105C    8B3D 00604000   mov edi,dword ptr ds:[&lt;&amp;KERNEL32.HeapFree&gt;]         ; ntdll.RtlFreeHeap
    00401062    53              push ebx
    00401063    6A 00           push 0x0
    00401065    56              push esi
f2  00401066    FFD7            call edi                                            ; ntdll.RtlAllocateHeap
    00401068    55              push ebp
    00401069    6A 00           push 0x0
    0040106B    56              push esi
f2  0040106C    FFD7            call edi                                            ; ntdll.RtlAllocateHeap
    0040106E    8B4424 10       mov eax,dword ptr ss:[esp+0x10]
    00401072    50              push eax
    00401073    6A 00           push 0x0
    00401075    56              push esi
f2  00401076    FFD7            call edi                                            ; ntdll.RtlAllocateHeap
    00401078    8B4C24 14       mov ecx,dword ptr ss:[esp+0x14]
    0040107C    51              push ecx                                            ; ntdll.7C9301BB
    0040107D    6A 00           push 0x0
    0040107F    56              push esi
    00401080    FFD7            call edi                                            ; ntdll.RtlAllocateHeap
    00401082    5F              pop edi                                             ; 00320036
    00401083    5E              pop esi                                             ; 00320036
    00401084    5D              pop ebp                                             ; 00320036
    00401085    33C0            xor eax,eax
    00401087    5B              pop ebx                                             ; 00320036
    00401088    83C4 08         add esp,0x8
    0040108B    C3              retn

f8
f8
...
(eip=401068)
    åˆ°401068å¤„,h1å †å—è¢«é‡Šæ”¾,ç”±äºh1å®é™…åˆ†é…å¤§å°ä¸º2ä¸ªå †å•å…ƒå¤§å°(2*8=16å­—èŠ‚),é‡Šæ”¾åå°†é“¾å…¥free[2]è¿™ä¸ªç©ºé—²é“¾è¡¨ä¸­
    ,åœ¨h1é‡Šæ”¾ä¹‹å‰åªæœ‰free[0]è¿™ä¸€ä¸ªç©ºé—²é“¾è¡¨,h1é‡Šæ”¾åä¼šå¢åŠ ä¸€ä¸ªç©ºé—²é“¾è¡¨free[2],æ­¤æ—¶free[2]è¿™ä¸ªç©ºè¡¨åªæœ‰ä¸€ä¸ªç»“ç‚¹,æ­¤
    æ—¶free[0]é™„è¿‘æ•°æ®:

    eip=40105cæ—¶,ä¹Ÿå³ä¸Šé¢é‡Šæ”¾h1ä¹‹å‰,free[0]=3a0178,é™„è¿‘çš„æ•°æ®å¦‚ä¸‹:

    003A0170  00 00 00 00 00 00 00 00 08 07 3A 00 08 07 3A 00  ........:.:.
    003A0180  80 01 3A 00 80 01 3A 00 88 01 3A 00 88 01 3A 00  â‚¬:.â‚¬:.?:.?:.
    003A0190  90 01 3A 00 90 01 3A 00 98 01 3A 00 98 01 3A 00  ?:.?:.?:.?:.
    003A01A0  A0 01 3A 00 A0 01 3A 00 A8 01 3A 00 A8 01 3A 00  ?:.?:.?:.?:.
    003A01B0  B0 01 3A 00 B0 01 3A 00 B8 01 3A 00 B8 01 3A 00  ?:.?:.?:.?:.
    003A01C0  C0 01 3A 00 C0 01 3A 00 C8 01 3A 00 C8 01 3A 00  ?:.?:.?:.?:.
    003A01D0  D0 01 3A 00 D0 01 3A 00 D8 01 3A 00 D8 01 3A 00  ?:.?:.?:.?:.
    003A01E0  E0 01 3A 00 E0 01 3A 00 E8 01 3A 00 E8 01 3A 00  ?:.?:.?:.?:.
    003A01F0  F0 01 3A 00 F0 01 3A 00 F8 01 3A 00 F8 01 3A 00  ?:.?:.?:.?:.
    
    ç°åœ¨,eip=401068æ—¶,åˆšé‡Šæ”¾å®Œh1,free[0]=3a0178,é™„è¿‘æ•°æ®å¦‚ä¸‹:

    003A0170  00 00 00 00 00 00 00 00 08 07 3A 00 08 07 3A 00  ........:.:.
    003A0180  80 01 3A 00 80 01 3A 00(88 06 3A 00 88 06 3A 00) â‚¬:.â‚¬:.?:.?:.
    003A0190  90 01 3A 00 90 01 3A 00 98 01 3A 00 98 01 3A 00  ?:.?:.?:.?:.
    003A01A0  A0 01 3A 00 A0 01 3A 00 A8 01 3A 00 A8 01 3A 00  ?:.?:.?:.?:.
    003A01B0  B0 01 3A 00 B0 01 3A 00 B8 01 3A 00 B8 01 3A 00  ?:.?:.?:.?:.
    003A01C0  C0 01 3A 00 C0 01 3A 00 C8 01 3A 00 C8 01 3A 00  ?:.?:.?:.?:.
    003A01D0  D0 01 3A 00 D0 01 3A 00 D8 01 3A 00 D8 01 3A 00  ?:.?:.?:.?:.
    003A01E0  E0 01 3A 00 E0 01 3A 00 E8 01 3A 00 E8 01 3A 00  ?:.?:.?:.?:.
    003A01F0  F0 01 3A 00 F0 01 3A 00 F8 01 3A 00 F8 01 3A 00  ?:.?:.?:.?:.
    
    ä¸åŒä¹‹å¤„æ˜¯3a0188å’Œ3a018cå¤„çš„003a0188å˜æˆäº†003a0688,è€Œ003a0688æ­£æ˜¯h1çš„å€¼,è€Œh1é‡Šæ”¾åå°†é“¾å…¥free[2]çš„ç©ºè¡¨,è¯´æ˜
    3a0188æ­£æ˜¯free[2]è¿™ä¸ªä½ç½®,é‚£ä¹ˆ3a0180å°±æ˜¯free[1]çš„ä½ç½®,ä¹Ÿå³ä»+0x178å¼€å§‹,æœ‰128ä¸ªå…ƒç´ ,æ¯ä¸ª8å­—èŠ‚å¤§å°,è¿™
    128ä¸ªå…ƒç´ æ„æˆä¸€ä¸ªæŒ‡é’ˆæ•°ç»„,è¿™ä¸ªæ•°ç»„å«åš"ç©ºè¡¨ç´¢å¼•",è¿™ä¸ªæ•°ç»„çš„æ¯ä¸€é¡¹åŒ…æ‹¬ä¸¤ä¸ªæŒ‡é’ˆ,æŒ‡é’ˆä»£è¡¨å¯¹åº”ç©ºè¡¨çš„ç¬¬ä¸€ä¸ªç©º
    é—²å †å—çš„å†…å­˜åœ°å€.

f8
f8
...
(eip=40106e)
    åˆ°è¿™é‡Œh3é‡Šæ”¾å®Œ,ç”±äºh3ä¹Ÿæ˜¯ä¸¤ä¸ªå †å—å•å…ƒå¤§å°,æ‰€ä»¥h3ä¹Ÿå°†é“¾å…¥åˆ°free[2]çš„ç©ºè¡¨å½“ä¸­
    å¯ä»¥é¢„æµ‹:
    free[2]å¤„çš„003a0688(free[2]çš„ç¬¬ä¸€ä¸ªç©ºé—²å †å—çš„ç´¢å¼•)å¯¹åº”çš„å†…å­˜å€¼[003a0688]=h3=003a06a8,è€Œ
    [003a0688+4]=free[2]=3a0188,è€Œ[003a06a8]=free[2]=003a0188,[003a06a8+4]=003a0688,free[2]ä¸º3a0188,h3é‡Šæ”¾å
    [3a0188]=3a0688,[3a0188+4]=3a06a8

    å®é™…ç¡®å®å¦‚æ­¤,å®é™…æ•°æ®å¦‚ä¸‹:

    003A0680  02 00 08 00 AA 00 0D 00 A8 06 3A 00 88 01 3A 00  ..?..?:.?:.

    003A06A0  02 00 02 00 AE 00 0A 00 88 01 3A 00 88 06 3A 00  ..?..?:.?:.

    003A0180  80 01 3A 00 80 01 3A 00 88 06 3A 00 A8 06 3A 00  â‚¬:.â‚¬:.?:.?:.

    å¦‚ä¸‹å›¾ï¼š
</code></pre>
</div>
<p><img src="https://raw.githubusercontent.com/3xp10it/pic/master/heap-3.png" /></p>

<div class="highlighter-rouge"><pre class="highlight"><code>f8
f8
...
(eip=401078)
    åˆ°è¿™é‡Œh5é‡Šæ”¾å®Œï¼Œç”±äº









    








</code></pre>
</div>

<h4 id="section">2&gt;æ¼æ´æˆ˜äº‰å®ä¾‹</h4>

<div class="highlighter-rouge"><pre class="highlight"><code>------------------heapoverflow.c---------------------
#include &lt;windows.h&gt;
#include &lt;stdio.h&gt;

int main()
{
    HANDLE hHeap;
    char *heap;
    char str[]="AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA";
    hHeap=HeapCreate(HEAP_GENERATE_EXCEPTIONS,0x1000,0xffff);
    getchar();

    heap=HeapAlloc(hHeap,0,0x10);
    printf("heap addr:0x%08x\n",heap);

    strcpy(heap,str);
    HeapFree(hHeap,0,heap);

    HeapDestroy(hHeap);
    return 0;
}
------------------------end--------------------------
</code></pre>
</div>
</span>

        


        
        <div class="tags">
          <small>
          <i class="fa fa-tags"></i>
            æ¼æ´æˆ˜äº‰, æ¼æ´åˆ†æ, å †æº¢å‡º
          </small>
        </div>
        

      </div>

      
      <div class="content-panel feedback">
        I <i class="fa fa-heart"></i> feedback.<br />
        Let me know what you think of this article on twitter <a href="https://www.twitter.com/quanyechavshuo">@quanyechavshuo</a>!
      </div>
      


      



      
<!-- å¤šè¯´è¯„è®ºæ¡† start -->
<div class="ds-thread" data-thread-key="/%E4%BA%8C%E8%BF%9B%E5%88%B6/2016/08/17/æ¼æ´æˆ˜äº‰-cve-2010-2553" data-title="" data-url="https://3xp10it.github.io//%E4%BA%8C%E8%BF%9B%E5%88%B6/2016/08/17/%E6%BC%8F%E6%B4%9E%E6%88%98%E4%BA%89-cve-2010-2553/"></div>
<!-- å¤šè¯´è¯„è®ºæ¡† end -->
<!-- å¤šè¯´å…¬å…±JSä»£ç  start (ä¸€ä¸ªç½‘é¡µåªéœ€æ’å…¥ä¸€æ¬¡) -->
<script type="text/javascript">
var duoshuoQuery = {short_name:"3xp10it"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
<!-- å¤šè¯´å…¬å…±JSä»£ç  end -->
      


      

    </div>

  </div>

</div>





      </div>
    </div>

    <div class="footer clearfix">
  <div class="col-md-12">
    for better experience please install font æ–‡æ³‰é©¿ç­‰å®½æ­£é»‘
  </div>
</div>

<div class="my-home"><i class="fa fa-home" aria-hidden="true"></i><a href="/index2.html"> <font color="white">home</font></a></div>
<div class="my-papers"><i class="fa fa-github" aria-hidden="true"></i><a href="https://github.com/3xp10it" target="_top"> <font color="white">papers</font></a></div>
<div class="my-search"><i class="fa fa-search" aria-hidden="true"></i><a href="/search/"> <font color="white">search</font></a></div>
<div class="my-archive"><i class="fa fa-apple" aria-hidden="true"></i><a href="/my-archive/"> <font color="white">archive</font></a></div>
<div class="my-categories"><i class="fa fa-tags" aria-hidden="true"></i><a href="/my-categories/"> <font color="white">categories</font></a></div>


<script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
<script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>
<script src="/js/jquery.mmenu.min.all.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/8.7/highlight.min.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script type="text/javascript">
   $(document).ready(function() {
      $("#my-menu").mmenu().on( "closed.mm", function() {
            $(".menu-button").show();
         });
      $(".menu-button").click(function() {
        $(".menu-button").hide();
        $("#my-menu").trigger("open.mm");
      });
   });
</script>






    </body>
</html>
